services:
  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: scholarship_redis_staging
    ports:
      - "6379:6379"
    volumes:
      - redis_staging_data:/data
    networks:
      - scholarship_staging_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # FastAPI Backend
  backend:
    image: ghcr.io/jotpalch/scholarship-system-backend:${TAG:-latest}
    container_name: scholarship_backend_staging
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000
    ports:
      - "8000:8000"
    environment:
      DATABASE_URL: ${DATABASE_URL:-postgresql+asyncpg://scholarship_user:scholarship_pass@10.113.74.25:5432/scholarship_db}
      DATABASE_URL_SYNC: ${DATABASE_URL_SYNC:-postgresql://scholarship_user:scholarship_pass@10.113.74.25:5432/scholarship_db}
      REDIS_URL: redis://redis:6379/0
      SECRET_KEY: ${SECRET_KEY:-staging-secret-key-for-docker-staging-only}
      DEBUG: "true"
      CORS_ORIGINS: ${CORS_ORIGINS:-*}
      ENVIRONMENT: production
      MINIO_ENDPOINT: ${MINIO_ENDPOINT:-10.113.74.25:9000}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin123}
      MINIO_BUCKET: ${MINIO_BUCKET:-scholarship-documents}
      MINIO_SECURE: "false"
      # Mock SSO Configuration for Testing (fallback)
      ENABLE_MOCK_SSO: "false"
      # Portal SSO Configuration (real Portal for testing)
      PORTAL_SSO_ENABLED: "true"
      PORTAL_JWT_SERVER_URL: "https://portal.test.nycu.edu.tw/jwt/portal"
      PORTAL_TEST_MODE: "false"
      PORTAL_SSO_TIMEOUT: "10.0"
      FRONTEND_URL: ${FRONTEND_URL:-https://ss.test.nycu.edu.tw}
      # Security Configuration
      BYPASS_TIME_RESTRICTIONS: "false"
      # Student API Configuration (Real NYCU API)
      STUDENT_API_ENABLED: "true"
      STUDENT_API_BASE_URL: ${STUDENT_API_BASE_URL:-http://140.113.7.136/api/SoAA}
      STUDENT_API_ACCOUNT: ${STUDENT_API_ACCOUNT:-scholarship}
      STUDENT_API_HMAC_KEY: ${STUDENT_API_HMAC_KEY:-4d6f636b4b657946726f6d48657841424344454647484a4b4c4d4e4f505152535455565758595a}
      STUDENT_API_TIMEOUT: "10.0"
      STUDENT_API_ENCODE_TYPE: "UTF-8"
      # Super Admin Configuration
      SUPER_ADMIN_NYCU_ID: ${SUPER_ADMIN_NYCU_ID:-super_admin}
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - scholarship_staging_network
    restart: unless-stopped

  # Nginx Load Balancer
  nginx:
    image: nginx:alpine
    container_name: scholarship_nginx_staging
    ports:
      - "443:443"
    volumes:
      - ./nginx/nginx.staging.conf:/etc/nginx/nginx.conf:ro
      - /etc/nginx/ssl:/etc/nginx/ssl:ro
      - ./logs/nginx:/var/log/nginx
    depends_on:
      - backend
      - frontend
    networks:
      - scholarship_staging_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "https://localhost/health", "-k"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Next.js Frontend
  frontend:
    image: ghcr.io/jotpalch/scholarship-system-frontend:${TAG:-latest}
    container_name: scholarship_frontend_staging
    ports:
      - "3000:3000"
    environment:
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-https://ss.test.nycu.edu.tw}
      NEXT_PUBLIC_NYCU_PORTAL_URL: ${NEXT_PUBLIC_NYCU_PORTAL_URL:-https://portal.test.nycu.edu.tw}
      NODE_ENV: ${NODE_ENV:-production}
      # Override for Docker internal requests if needed
      INTERNAL_API_URL: http://backend:8000
      # Debug Panel Control
      NEXT_PUBLIC_ENABLE_DEBUG_PANEL: "true"
    depends_on:
      - backend
    networks:
      - scholarship_staging_network
    restart: unless-stopped

  # =========================================================================
  # MONITORING SERVICES
  # =========================================================================

  # Grafana Alloy - Unified telemetry collector
  alloy:
    image: grafana/alloy:latest
    container_name: scholarship_alloy_staging_ap
    volumes:
      - ./monitoring/config/alloy/staging-ap-vm.alloy:/etc/alloy/config.alloy:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./logs/nginx:/var/log/nginx:ro
    networks:
      - scholarship_staging_network
    command: run --server.http.listen-addr=0.0.0.0:12345 /etc/alloy/config.alloy
    restart: unless-stopped
    depends_on:
      - backend
      - frontend
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"

  # Node Exporter - System metrics
  node-exporter:
    image: prom/node-exporter:latest
    container_name: node_exporter_staging_ap
    command:
      - '--path.rootfs=/host'
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    volumes:
      - /:/host:ro,rslave
    expose:
      - "9100"
    networks:
      - scholarship_staging_network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"

  # cAdvisor - Container metrics
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: cadvisor_staging_ap
    privileged: true
    devices:
      - /dev/kmsg
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    expose:
      - "8080"
    networks:
      - scholarship_staging_network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"

  # Nginx Prometheus Exporter
  nginx-exporter:
    image: nginx/nginx-prometheus-exporter:latest
    container_name: nginx_exporter_staging_ap
    command:
      - '-nginx.scrape-uri=http://nginx:80/nginx_status'
    expose:
      - "9113"
    depends_on:
      - nginx
    networks:
      - scholarship_staging_network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"

volumes:
  redis_staging_data:
    driver: local

networks:
  scholarship_staging_network:
    external: true
    name: scholarship_staging_network
