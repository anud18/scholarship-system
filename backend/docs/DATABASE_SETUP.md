# Database Setup Guide

## 新資料庫初始化流程

這份指南說明如何從零開始建立資料庫。

### 前提條件

- PostgreSQL 15+ 已安裝並運行
- Python 3.11+ 環境已設置
- 已安裝所有依賴套件 (`pip install -r requirements.txt`)

### 方法 1: 使用 Docker (推薦)

```bash
# 1. 清理舊環境（如果需要）
docker-compose -f docker-compose.dev.yml down -v

# 2. 啟動服務
docker-compose -f docker-compose.dev.yml up -d

# 3. 等待 PostgreSQL 就緒
docker-compose -f docker-compose.dev.yml exec backend alembic current

# 4. 執行 migration
docker-compose -f docker-compose.dev.yml exec backend alembic upgrade head

# 5. Seed 開發資料
docker-compose -f docker-compose.dev.yml exec backend python -m app.seed

# 6. 驗證
docker-compose -f docker-compose.dev.yml exec backend python -c "
import asyncio
from app.db.session import AsyncSessionLocal
from sqlalchemy import text

async def check():
    async with AsyncSessionLocal() as db:
        result = await db.execute(text('SELECT COUNT(*) FROM users'))
        print(f'Users count: {result.scalar()}')

asyncio.run(check())
"
```

### 方法 2: 本地開發環境

#### Step 1: 建立資料庫

```bash
# 使用 psql 或其他工具建立資料庫
psql -U postgres -c "CREATE DATABASE scholarship_dev;"
```

#### Step 2: 設定環境變數

```bash
export DATABASE_URL="postgresql+asyncpg://postgres:postgres@localhost:5432/scholarship_dev"
export DATABASE_URL_SYNC="postgresql://postgres:postgres@localhost:5432/scholarship_dev"
export APP_ENV="development"
```

#### Step 3: 執行 Alembic Migrations

```bash
# 檢查當前版本（應該是空的）
alembic current

# 執行所有 migration 到最新版本
alembic upgrade head

# 檢查 migration 結果
alembic current
# 輸出: 91f7e98e5d0a (head), Scholarship reference data
```

#### Step 4: Seed 開發資料

```bash
# 開發環境：包含測試用戶和完整測試資料
python -m app.seed

# 生產環境：僅包含 admin 用戶
python -m app.seed --prod
```

#### Step 5: 驗證資料庫

```python
# 執行快速驗證
python -c "
import asyncio
from app.db.session import AsyncSessionLocal
from sqlalchemy import text

async def verify():
    async with AsyncSessionLocal() as db:
        # 檢查 lookup tables
        result = await db.execute(text('SELECT COUNT(*) FROM degree'))
        print(f'✓ Degrees: {result.scalar()}')

        result = await db.execute(text('SELECT COUNT(*) FROM department'))
        print(f'✓ Departments: {result.scalar()}')

        result = await db.execute(text('SELECT COUNT(*) FROM users'))
        print(f'✓ Users: {result.scalar()}')

asyncio.run(verify())
"
```

## Migration 架構

### 已完成的 Migrations

1. **4f0a9ad1219f**: Initial schema and lookup tables
   - 建立所有 lookup/reference tables
   - Degrees (學位)
   - Identities (身份別)
   - Studying Status (在學狀態)
   - Academies (學院)
   - Departments (系所)
   - Enrollment Types (入學管道)

2. **91f7e98e5d0a**: Scholarship reference data
   - 獎學金參考資料由 seed script 處理
   - 見 `app/seed.py` 中的 `seed_scholarships()` 和 `seed_application_fields()`

### Migration 使用說明

```bash
# 查看 migration 歷史
alembic history

# 查看當前版本
alembic current

# 升級到最新版本
alembic upgrade head

# 升級到特定版本
alembic upgrade 4f0a9ad1219f

# 降級一個版本
alembic downgrade -1

# 降級到特定版本
alembic downgrade 6b9a429f965b
```

## Seed Script 架構

### 功能特點

1. **冪等性 (Idempotent)**
   - 使用 `ON CONFLICT DO UPDATE` 確保可重複執行
   - 不會產生重複資料

2. **Advisory Locks**
   - PostgreSQL advisory locks 防止併發執行
   - Lock ID: `1234567890`

3. **環境感知**
   - Development: 完整測試資料
   - Production: 僅 admin 用戶

### Seed Script 使用

```bash
# 開發環境（預設）
python -m app.seed

# 明確指定開發環境
APP_ENV=development python -m app.seed

# 生產環境
python -m app.seed --prod

# 或使用環境變數
APP_ENV=production python -m app.seed
```

### Seed 資料內容

#### Development Mode
- ✓ Lookup tables（由 `initLookupTables` 處理）
- ✓ 測試用戶（15+ users）:
  - admin@nycu.edu.tw (Admin)
  - super_admin@nycu.edu.tw (Super Admin)
  - professor@nycu.edu.tw (Professor)
  - college@nycu.edu.tw (College Reviewer)
  - 多個學生帳號（學士/碩士/博士）

#### Production Mode
- ✓ Lookup tables
- ✓ Admin 用戶（從 `ADMIN_EMAIL` 環境變數）

## 常見問題

### Q: Migration 失敗，提示欄位已存在？
A: 資料庫可能不是乾淨的狀態。建議：
```bash
# 方法 1: 完全重建（會遺失資料！）
docker-compose -f docker-compose.dev.yml down -v
docker-compose -f docker-compose.dev.yml up -d

# 方法 2: 手動清理
alembic downgrade base
alembic upgrade head
```

### Q: Seed script 提示表不存在？
A: 需要先執行 migration：
```bash
alembic upgrade head
python -m app.seed
```

### Q: 如何重置開發資料？
A: Seed script 是冪等的，可以直接重新執行：
```bash
python -m app.seed
```

### Q: 生產環境如何初始化？
A:
```bash
# 1. 設定環境變數
export APP_ENV=production
export DATABASE_URL_SYNC="postgresql://..."
export ADMIN_EMAIL="admin@yourdomain.edu.tw"

# 2. 執行 migration
alembic upgrade head

# 3. Seed admin 用戶
python -m app.seed --prod
```

## 資料庫架構原則

### 1. Server Defaults
- 所有預設值在資料庫層級定義
- 使用 `server_default` in SQLAlchemy models
- 範例: `CURRENT_TIMESTAMP`, `GENERATED BY DEFAULT AS IDENTITY`

### 2. Alembic Migrations
- **Schema changes**: 表結構、索引、約束
- **Reference data**: Lookup tables 等不變資料

### 3. Seed Scripts
- **Environment data**: 測試用戶、範例資料
- **Production setup**: 最小必要資料
- **冪等性**: 可重複執行
- **Advisory locks**: 防止併發

## 檢查清單

建立新環境時的檢查清單：

- [ ] PostgreSQL 15+ 已安裝並運行
- [ ] 資料庫已建立 (`CREATE DATABASE`)
- [ ] 環境變數已設定（`DATABASE_URL`, `DATABASE_URL_SYNC`）
- [ ] Alembic migration 已執行 (`alembic upgrade head`)
- [ ] Seed script 已執行 (`python -m app.seed`)
- [ ] 資料庫驗證通過（user count > 0）
- [ ] 應用程式可正常啟動 (`uvicorn app.main:app`)

---

最後更新: 2025-09-24