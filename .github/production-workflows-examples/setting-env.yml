# Production Environment Setup Workflow
# This workflow should be copied to production repository at: .github/workflows/setting-env.yml
#
# Purpose: Automate Docker installation and environment setup
# - Installs Docker Engine on AP VM (online) and DB VM (offline)
# - Transfers Docker images to DB VM
# - Creates necessary directory structure with correct permissions
# - Generates .env files from GitHub Secrets
#
# GitHub Runner: Runs on self-hosted runner installed on AP VM
# Reference: See installation manual Section 3 (Docker) and Section 6 (GitHub Runner)

name: Setup Production Environment

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - validate
          - setup
          - full-check
        default: 'validate'

jobs:
  setup-environment:
    name: ${{ github.event.inputs.action == 'validate' && 'Validate Environment' || github.event.inputs.action == 'setup' && 'Setup Environment' || 'Full Check & Setup' }}
    runs-on: [self-hosted, linux]

    steps:
      #########################################################################
      # STEP 1: Checkout Code
      #########################################################################
      - name: Checkout repository
        uses: actions/checkout@v4

      #########################################################################
      # STEP 2: Validate Docker Setup Secrets (Simplified)
      #########################################################################
      - name: Validate Docker Setup Secrets
        if: github.event.inputs.action == 'validate' || github.event.inputs.action == 'setup' || github.event.inputs.action == 'full-check'
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_VM_USER: ${{ secrets.DB_VM_USER }}
          DB_VM_SSH_KEY: ${{ secrets.DB_VM_SSH_KEY }}
          DB_VM_SSH_PORT: ${{ secrets.DB_VM_SSH_PORT }}
        run: |
          echo "=========================================="
          echo "Validating Docker Setup Secrets"
          echo "=========================================="
          echo ""
          echo "â„¹ï¸  This workflow focuses on Docker installation."
          echo "   Only Docker-related secrets are validated here."
          echo "   Other secrets will be validated during .env generation."
          echo ""

          # Mask SSH key
          echo "::add-mask::$DB_VM_SSH_KEY"

          VALIDATION_FAILED=0

          echo "ðŸ”‘ Docker Setup Requirements:"
          if [ -z "$DB_HOST" ]; then
            echo "âŒ MISSING: DB_HOST (required for DB VM access)"
            VALIDATION_FAILED=1
          else
            echo "âœ… DB_HOST: configured"
          fi

          if [ -z "$DB_VM_USER" ]; then
            echo "âŒ MISSING: DB_VM_USER (required for SSH to DB VM)"
            VALIDATION_FAILED=1
          else
            echo "âœ… DB_VM_USER: configured"
          fi

          if [ -z "$DB_VM_SSH_KEY" ]; then
            echo "âŒ MISSING: DB_VM_SSH_KEY (required for SSH authentication)"
            VALIDATION_FAILED=1
          else
            echo "âœ… DB_VM_SSH_KEY: configured"
          fi

          if [ -z "$DB_VM_SSH_PORT" ]; then
            echo "âŒ MISSING: DB_VM_SSH_PORT (required for SSH connection)"
            VALIDATION_FAILED=1
          else
            echo "âœ… DB_VM_SSH_PORT: configured"
          fi
          echo ""

          if [ $VALIDATION_FAILED -eq 1 ]; then
            echo "=========================================="
            echo "âŒ Docker Setup Secrets Validation FAILED"
            echo "=========================================="
            echo ""
            echo "Required secrets for Docker installation:"
            echo "- DB_HOST: Database VM hostname or IP"
            echo "- DB_VM_USER: SSH username for DB VM"
            echo "- DB_VM_SSH_KEY: SSH private key for DB VM"
            echo "- DB_VM_SSH_PORT: SSH port number (e.g., 8822)"
            echo ""
            echo "See SECRETS-SETUP-GUIDE.md for setup instructions"
            exit 1
          else
            echo "=========================================="
            echo "âœ… Docker Setup Secrets Validated"
            echo "=========================================="
            echo ""
            echo "Note: Other secrets (database credentials, application secrets,"
            echo "      email config, etc.) will be validated when generating"
            echo "      .env file in later steps."
          fi

      #########################################################################
      # STEP 2.5: Setup System Prerequisites on AP VM
      #########################################################################
      - name: Setup System Prerequisites on AP VM
        if: github.event.inputs.action == 'setup' || github.event.inputs.action == 'full-check'
        run: |
          echo "=========================================="
          echo "Setting up System Prerequisites on AP VM"
          echo "=========================================="
          echo ""
          echo "â„¹ï¸  Configuring LVM disk extension and NTP time synchronization."
          echo ""

          #####################################################################
          # Step 1: LVM Disk Extension
          #####################################################################
          echo "=========================================="
          echo "Step 1: LVM Disk Extension"
          echo "=========================================="
          echo ""

          # Check if bc is installed (needed for floating-point comparison)
          if ! command -v bc &> /dev/null; then
            echo "ðŸ“¦ Installing bc (required for LVM checks)..."
            sudo apt-get update > /dev/null 2>&1
            sudo apt-get install -y bc > /dev/null 2>&1
          fi

          # Check VG free space
          echo "ðŸ” Checking available disk space in volume group..."
          VG_FREE=$(sudo vgs --noheadings -o vg_free --units g ubuntu-vg 2>/dev/null | tr -d ' G' || echo "0")
          echo "   Available space: ${VG_FREE}G"
          echo ""

          # Extend LV if free space available
          if (( $(echo "$VG_FREE > 1" | bc -l) )); then
            echo "ðŸ“ˆ Extending logical volume by 95% of free space..."
            if sudo lvextend -l +95%FREE /dev/ubuntu-vg/ubuntu-lv; then
              echo "   âœ… Logical volume extended"
            else
              echo "   âš ï¸  LV extension failed (may not be critical)"
            fi

            echo "ðŸ“ Resizing filesystem..."
            if sudo resize2fs /dev/ubuntu-vg/ubuntu-lv; then
              echo "   âœ… Filesystem resized"
            else
              echo "   âš ï¸  Filesystem resize failed"
            fi

            echo ""
            echo "ðŸ’¾ Current disk usage:"
            df -h | grep ubuntu-lv || df -h | grep "/$"
          else
            echo "âœ… LVM already extended or no free space available (VG free: ${VG_FREE}G)"
          fi
          echo ""

          #####################################################################
          # Step 2: NTP Time Synchronization Setup
          #####################################################################
          echo "=========================================="
          echo "Step 2: NTP Time Synchronization"
          echo "=========================================="
          echo ""

          echo "ðŸ• Configuring NTP time sync with time.stdtime.gov.tw..."

          # Backup existing config
          if [ -f /etc/systemd/timesyncd.conf ]; then
            sudo cp /etc/systemd/timesyncd.conf /etc/systemd/timesyncd.conf.bak.$(date +%Y%m%d-%H%M%S) 2>/dev/null || true
            echo "   âœ… Backed up existing timesyncd.conf"
          fi

          # Configure NTP server
          {
            echo "[Time]"
            echo "NTP=time.stdtime.gov.tw"
            echo "FallbackNTP=ntp.ubuntu.com time.google.com"
          } | sudo tee /etc/systemd/timesyncd.conf > /dev/null
          echo "   âœ… NTP server configured: time.stdtime.gov.tw"

          # Restart and enable time sync
          echo "ðŸ”„ Restarting time synchronization service..."
          sudo systemctl restart systemd-timesyncd
          sudo timedatectl set-ntp true
          echo "   âœ… Time synchronization enabled"
          echo ""

          # Verify configuration
          echo "ðŸ” Current time sync status:"
          timedatectl status | grep -E "(NTP service|System clock|Time zone)" || timedatectl status
          echo ""

          echo "=========================================="
          echo "âœ… System Prerequisites Setup Complete"
          echo "=========================================="
          echo ""

      #########################################################################
      # STEP 4: Install Docker on AP VM (Online)
      #########################################################################
      - name: Install Docker on AP VM
        if: github.event.inputs.action == 'setup' || github.event.inputs.action == 'full-check'
        run: |
          echo "=========================================="
          echo "Installing Docker on AP VM"
          echo "=========================================="
          echo ""
          echo "â„¹ï¸  AP VM has internet access."
          echo "   Docker will be installed directly from official repository."
          echo ""

          #####################################################################
          # Check if Docker is already installed
          #####################################################################
          echo "=========================================="
          echo "Step 1: Checking Existing Docker Installation"
          echo "=========================================="
          echo ""

          DOCKER_INSTALLED=false
          if command -v docker &> /dev/null && docker compose version &> /dev/null; then
            DOCKER_VERSION=$(docker --version 2>/dev/null || echo "unknown")
            COMPOSE_VERSION=$(docker compose version 2>/dev/null || echo "unknown")

            echo "âœ… Docker is already installed on AP VM:"
            echo "   $DOCKER_VERSION"
            echo "   $COMPOSE_VERSION"
            echo ""
            echo "â­ï¸  Skipping Docker installation"
            DOCKER_INSTALLED=true
          else
            echo "âš ï¸  Docker is NOT installed on AP VM"
            echo "   Will proceed with online installation"
            DOCKER_INSTALLED=false
          fi
          echo ""

          if [ "$DOCKER_INSTALLED" = true ]; then
            echo "=========================================="
            echo "âœ… Docker Already Installed - Skipping"
            echo "=========================================="
            exit 0
          fi

          #####################################################################
          # Step 2: Install Prerequisites
          #####################################################################
          echo "=========================================="
          echo "Step 2: Installing Prerequisites"
          echo "=========================================="
          echo ""

          echo "ðŸ“¦ Installing ca-certificates, curl, gnupg..."
          if sudo apt-get update > /dev/null 2>&1 && sudo apt-get install -y ca-certificates curl gnupg lsb-release libmagic1 > /dev/null 2>&1; then
            echo "   âœ… Prerequisites installed"
          else
            echo "   âŒ Failed to install prerequisites"
            exit 1
          fi
          echo ""

          #####################################################################
          # Step 3: Add Docker Repository
          #####################################################################
          echo "=========================================="
          echo "Step 3: Adding Docker Repository"
          echo "=========================================="
          echo ""

          echo "ðŸ”‘ Adding Docker GPG key..."
          sudo install -m 0755 -d /etc/apt/keyrings
          if curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg > /dev/null 2>&1; then
            sudo chmod a+r /etc/apt/keyrings/docker.gpg
            echo "   âœ… Docker GPG key added"
          else
            echo "   âŒ Failed to add Docker GPG key"
            exit 1
          fi

          echo "ðŸ“ Adding Docker repository..."
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
          echo "   âœ… Docker repository added"
          echo ""

          #####################################################################
          # Step 4: Install Docker Packages
          #####################################################################
          echo "=========================================="
          echo "Step 4: Installing Docker Packages"
          echo "=========================================="
          echo ""

          echo "ðŸ“¥ Updating package index..."
          if sudo apt-get update > /dev/null 2>&1; then
            echo "   âœ… Package index updated"
          else
            echo "   âŒ Failed to update package index"
            exit 1
          fi

          echo "ðŸ³ Installing Docker packages..."
          if sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin > /dev/null 2>&1; then
            echo "   âœ… Docker packages installed"
          else
            echo "   âŒ Failed to install Docker packages"
            exit 1
          fi
          echo ""

          #####################################################################
          # Step 5: Enable and Start Docker
          #####################################################################
          echo "=========================================="
          echo "Step 5: Enabling Docker Service"
          echo "=========================================="
          echo ""

          echo "ðŸš€ Starting Docker daemon..."
          if sudo systemctl enable --now docker > /dev/null 2>&1; then
            echo "   âœ… Docker service enabled and started"
          else
            echo "   âŒ Failed to start Docker service"
            exit 1
          fi

          # Add current user to docker group
          echo "ðŸ‘¤ Adding user to docker group..."
          sudo usermod -aG docker $USER || true
          echo "   âœ… User added to docker group"
          echo "   â„¹ï¸  Note: Group membership takes effect after re-login"
          echo ""

          #####################################################################
          # Step 6: Verify Installation
          #####################################################################
          echo "=========================================="
          echo "Step 6: Verifying Docker Installation"
          echo "=========================================="
          echo ""

          # Wait for Docker to be ready
          echo "â³ Waiting for Docker daemon to be ready..."
          sleep 3

          # Test Docker
          echo "ðŸ” Testing Docker installation..."
          DOCKER_VERSION=$(sudo docker --version 2>/dev/null || echo "")
          COMPOSE_VERSION=$(sudo docker compose version 2>/dev/null || echo "")

          if [ -n "$DOCKER_VERSION" ] && [ -n "$COMPOSE_VERSION" ]; then
            echo "   âœ… $DOCKER_VERSION"
            echo "   âœ… $COMPOSE_VERSION"
          else
            echo "   âŒ Docker installation verification failed"
            exit 1
          fi

          # Test Docker daemon
          echo "ðŸ” Testing Docker daemon..."
          if sudo docker ps > /dev/null 2>&1; then
            echo "   âœ… Docker daemon is running"
          else
            echo "   âŒ Docker daemon is not responding"
            exit 1
          fi
          echo ""

          echo "=========================================="
          echo "âœ… Docker Installation Complete on AP VM"
          echo "=========================================="
          echo ""
          echo "Docker Engine and Docker Compose have been successfully installed."
          echo ""

      #########################################################################
      # STEP 7: Install Docker Engine on DB VM (Offline Installation)
      #########################################################################
      - name: Install Docker Engine on DB VM (Offline)
        if: github.event.inputs.action == 'setup' || github.event.inputs.action == 'full-check'
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_VM_USER: ${{ secrets.DB_VM_USER }}
          DB_VM_SSH_KEY: ${{ secrets.DB_VM_SSH_KEY }}
          DB_VM_SSH_PORT: ${{ secrets.DB_VM_SSH_PORT }}
        run: |
          echo "=========================================="
          echo "Checking Docker Installation on DB VM"
          echo "=========================================="
          echo ""
          echo "â„¹ï¸  DB VM is offline and cannot install Docker from internet."
          echo "   If Docker is not installed, packages will be downloaded on AP VM"
          echo "   and transferred to DB VM for offline installation."
          echo ""

          # Mask SSH key
          echo "::add-mask::$DB_VM_SSH_KEY"

          # Setup SSH
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "$DB_VM_SSH_KEY" > ~/.ssh/db_vm_key
          chmod 600 ~/.ssh/db_vm_key

          # Add to known_hosts if needed
          if [ ! -f ~/.ssh/known_hosts ] || ! grep -q "$DB_HOST" ~/.ssh/known_hosts; then
            ssh-keyscan -p $DB_VM_SSH_PORT -H "$DB_HOST" >> ~/.ssh/known_hosts 2>/dev/null
          fi

          #####################################################################
          # Check if Docker is already installed on DB VM
          #####################################################################
          echo "=========================================="
          echo "Step 1: Checking Existing Docker Installation"
          echo "=========================================="
          echo ""

          DOCKER_INSTALLED=false
          if ssh -p $DB_VM_SSH_PORT -i ~/.ssh/db_vm_key -o ConnectTimeout=10 "$DB_VM_USER@$DB_HOST" "docker --version &>/dev/null && docker compose version &>/dev/null" 2>/dev/null; then
            DOCKER_VERSION=$(ssh -p $DB_VM_SSH_PORT -i ~/.ssh/db_vm_key "$DB_VM_USER@$DB_HOST" "docker --version" 2>/dev/null || echo "unknown")
            COMPOSE_VERSION=$(ssh -p $DB_VM_SSH_PORT -i ~/.ssh/db_vm_key "$DB_VM_USER@$DB_HOST" "docker compose version" 2>/dev/null || echo "unknown")

            echo "âœ… Docker is already installed on DB VM:"
            echo "   $DOCKER_VERSION"
            echo "   $COMPOSE_VERSION"
            echo ""
            echo "â­ï¸  Skipping Docker installation"
            DOCKER_INSTALLED=true
          else
            echo "âš ï¸  Docker is NOT installed on DB VM"
            echo "   Will proceed with offline installation"
            DOCKER_INSTALLED=false
          fi
          echo ""

          #####################################################################
          # Step 1.5: Setup System Prerequisites on DB VM
          #####################################################################
          echo "=========================================="
          echo "Step 1.5: System Prerequisites Setup on DB VM"
          echo "=========================================="
          echo ""
          echo "â„¹ï¸  Configuring LVM disk extension and NTP time synchronization."
          echo ""

          # Sub-step 1.5.1: LVM Disk Extension
          echo "ðŸ“¦ Step 1.5.1: LVM Disk Extension"
          echo "---"

          # Check if bc is installed on DB VM (needed for floating-point comparison)
          ssh -p $DB_VM_SSH_PORT -i ~/.ssh/db_vm_key "$DB_VM_USER@$DB_HOST" "
            if ! command -v bc &> /dev/null; then
              echo 'ðŸ“¦ Installing bc (required for LVM checks)...'
              sudo apt-get update > /dev/null 2>&1
              sudo apt-get install -y bc > /dev/null 2>&1
              echo '   âœ… bc installed'
            fi
          "

          # Check VG free space and extend if needed
          echo "ðŸ” Checking available disk space in volume group..."
          ssh -p $DB_VM_SSH_PORT -i ~/.ssh/db_vm_key "$DB_VM_USER@$DB_HOST" "
            VG_FREE=\$(sudo vgs --noheadings -o vg_free --units g ubuntu-vg 2>/dev/null | tr -d ' G' || echo '0')
            echo \"   Available space: \${VG_FREE}G\"
            echo \"\"

            if (( \$(echo \"\$VG_FREE > 1\" | bc -l) )); then
              echo 'ðŸ“ˆ Extending logical volume by 95% of free space...'
              if sudo lvextend -l +95%FREE /dev/ubuntu-vg/ubuntu-lv; then
                echo '   âœ… Logical volume extended'
              else
                echo '   âš ï¸  LV extension failed (may not be critical)'
              fi

              echo 'ðŸ“ Resizing filesystem...'
              if sudo resize2fs /dev/ubuntu-vg/ubuntu-lv; then
                echo '   âœ… Filesystem resized'
              else
                echo '   âš ï¸  Filesystem resize failed'
              fi

              echo ''
              echo 'ðŸ’¾ Current disk usage:'
              df -h | grep ubuntu-lv || df -h | grep '/\$'
            else
              echo \"âœ… LVM already extended or no free space available (VG free: \${VG_FREE}G)\"
            fi
          "
          echo ""

          # Sub-step 1.5.2: NTP Time Synchronization
          echo "ðŸ• Step 1.5.2: NTP Time Synchronization"
          echo "---"

          ssh -p $DB_VM_SSH_PORT -i ~/.ssh/db_vm_key "$DB_VM_USER@$DB_HOST" "
            echo 'Configuring NTP time sync with time.stdtime.gov.tw...'

            # Backup existing config
            if [ -f /etc/systemd/timesyncd.conf ]; then
              sudo cp /etc/systemd/timesyncd.conf /etc/systemd/timesyncd.conf.bak.\$(date +%Y%m%d-%H%M%S) 2>/dev/null || true
              echo '   âœ… Backed up existing timesyncd.conf'
            fi

            # Configure NTP server
            {
              echo '[Time]'
              echo 'NTP=time.stdtime.gov.tw'
              echo 'FallbackNTP=ntp.ubuntu.com time.google.com'
            } | sudo tee /etc/systemd/timesyncd.conf > /dev/null
            echo '   âœ… NTP server configured: time.stdtime.gov.tw'

            # Restart and enable time sync
            echo 'ðŸ”„ Restarting time synchronization service...'
            sudo systemctl restart systemd-timesyncd
            sudo timedatectl set-ntp true
            echo '   âœ… Time synchronization enabled'
            echo ''

            # Verify configuration
            echo 'ðŸ” Current time sync status:'
            timedatectl status | grep -E '(NTP service|System clock|Time zone)' || timedatectl status
          "
          echo ""

          echo "=========================================="
          echo "âœ… System Prerequisites Setup Complete on DB VM"
          echo "=========================================="
          echo ""

          if [ "$DOCKER_INSTALLED" = true ]; then
            echo "=========================================="
            echo "âœ… Docker Already Installed - Skipping Docker Installation"
            echo "=========================================="
            rm -f ~/.ssh/db_vm_key
            exit 0
          fi

          #####################################################################
          # Step 2: Download Docker Packages on AP VM
          #####################################################################
          echo "=========================================="
          echo "Step 2: Downloading Docker Packages on AP VM"
          echo "=========================================="
          echo ""

          # Create temporary directory
          DOCKER_TEMP="/tmp/docker-packages-$$"
          mkdir -p "$DOCKER_TEMP"

          echo "ðŸ“¦ Downloading Docker repository information..."

          # Add Docker's official GPG key
          sudo install -m 0755 -d /etc/apt/keyrings
          if curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo tee /etc/apt/keyrings/docker.asc > /dev/null; then
            sudo chmod a+r /etc/apt/keyrings/docker.asc
            echo "   âœ… Docker GPG key added"
          else
            echo "   âŒ Failed to download Docker GPG key"
            rm -rf "$DOCKER_TEMP" ~/.ssh/db_vm_key
            exit 1
          fi

          # Add Docker repository
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
          echo "   âœ… Docker repository configured"
          echo ""

          # Update package index
          echo "ðŸ“¦ Updating package index..."
          if sudo apt-get update > /dev/null 2>&1; then
            echo "   âœ… Package index updated"
          else
            echo "   âŒ Failed to update package index"
            rm -rf "$DOCKER_TEMP" ~/.ssh/db_vm_key
            exit 1
          fi
          echo ""

          # Download Docker packages
          echo "ðŸ“¥ Downloading Docker packages (this may take a few minutes)..."
          cd "$DOCKER_TEMP"

          PACKAGES=(
            "docker-ce"
            "docker-ce-cli"
            "containerd.io"
            "docker-buildx-plugin"
            "docker-compose-plugin"
          )

          for PKG in "${PACKAGES[@]}"; do
            echo "   Downloading $PKG..."
            if sudo apt-get download "$PKG" > /dev/null 2>&1; then
              echo "   âœ… $PKG downloaded"
            else
              echo "   âŒ Failed to download $PKG"
              rm -rf "$DOCKER_TEMP" ~/.ssh/db_vm_key
              exit 1
            fi
          done
          echo ""

          # Show downloaded packages
          echo "ðŸ“‹ Downloaded packages:"
          ls -lh "$DOCKER_TEMP"/*.deb | awk '{printf "   %s (%s)\n", $9, $5}'
          TOTAL_SIZE=$(du -sh "$DOCKER_TEMP" | cut -f1)
          echo "   Total size: $TOTAL_SIZE"
          echo ""

          #####################################################################
          # Step 3: Transfer Packages to DB VM
          #####################################################################
          echo "=========================================="
          echo "Step 3: Transferring Packages to DB VM"
          echo "=========================================="
          echo ""

          echo "ðŸ“¤ Transferring Docker packages to DB VM ($TOTAL_SIZE)..."
          if scp -P $DB_VM_SSH_PORT -i ~/.ssh/db_vm_key -o StrictHostKeyChecking=no "$DOCKER_TEMP"/*.deb "$DB_VM_USER@$DB_HOST:/tmp/"; then
            echo "   âœ… All packages transferred successfully"
          else
            echo "   âŒ Failed to transfer packages"
            rm -rf "$DOCKER_TEMP" ~/.ssh/db_vm_key
            exit 1
          fi
          echo ""

          #####################################################################
          # Step 4: Install Prerequisites on DB VM
          #####################################################################
          echo "=========================================="
          echo "Step 4: Installing Prerequisites on DB VM"
          echo "=========================================="
          echo ""

          echo "ðŸ“¦ Installing ca-certificates, curl, gnupg, lsb-release..."
          if ssh -p $DB_VM_SSH_PORT -i ~/.ssh/db_vm_key "$DB_VM_USER@$DB_HOST" "sudo apt-get update > /dev/null 2>&1 && sudo apt-get install -y ca-certificates curl gnupg lsb-release > /dev/null 2>&1"; then
            echo "   âœ… Prerequisites installed"
          else
            echo "   âš ï¸  Warning: Could not install prerequisites (may already be installed)"
          fi
          echo ""

          #####################################################################
          # Step 5: Install Docker on DB VM
          #####################################################################
          echo "=========================================="
          echo "Step 5: Installing Docker on DB VM"
          echo "=========================================="
          echo ""

          echo "ðŸ³ Installing Docker packages..."
          echo "   This will install in order: containerd â†’ docker-ce-cli â†’ docker-ce â†’ plugins"
          echo ""

          # Install packages in correct order
          INSTALL_ORDER=(
            "containerd.io"
            "docker-ce-cli"
            "docker-ce"
            "docker-buildx-plugin"
            "docker-compose-plugin"
          )

          for PKG in "${INSTALL_ORDER[@]}"; do
            echo "   Installing $PKG..."
            if ssh -p $DB_VM_SSH_PORT -i ~/.ssh/db_vm_key "$DB_VM_USER@$DB_HOST" "cd /tmp && sudo dpkg -i ${PKG}_*.deb 2>&1" | grep -qE "Unpacking|Setting up"; then
              echo "   âœ… $PKG installed"
            else
              echo "   âš ï¸  $PKG may already be installed or had warnings"
            fi
          done
          echo ""

          # Fix any dependency issues
          echo "ðŸ”§ Fixing any missing dependencies..."
          ssh -p $DB_VM_SSH_PORT -i ~/.ssh/db_vm_key "$DB_VM_USER@$DB_HOST" "sudo apt-get -f install -y > /dev/null 2>&1" || true
          echo "   âœ… Dependencies resolved"
          echo ""

          #####################################################################
          # Step 6: Enable and Start Docker
          #####################################################################
          echo "=========================================="
          echo "Step 6: Enabling Docker Service"
          echo "=========================================="
          echo ""

          echo "ðŸš€ Starting Docker daemon..."
          if ssh -p $DB_VM_SSH_PORT -i ~/.ssh/db_vm_key "$DB_VM_USER@$DB_HOST" "sudo systemctl enable --now docker > /dev/null 2>&1"; then
            echo "   âœ… Docker service enabled and started"
          else
            echo "   âŒ Failed to start Docker service"
            rm -rf "$DOCKER_TEMP" ~/.ssh/db_vm_key
            exit 1
          fi
          echo ""

          # Add user to docker group (optional, for non-root access)
          echo "ðŸ‘¤ Adding $DB_VM_USER to docker group..."
          ssh -p $DB_VM_SSH_PORT -i ~/.ssh/db_vm_key "$DB_VM_USER@$DB_HOST" "sudo usermod -aG docker $DB_VM_USER" > /dev/null 2>&1 || true
          echo "   âœ… User added to docker group (requires re-login to take effect)"
          echo ""

          #####################################################################
          # Step 7: Verify Installation
          #####################################################################
          echo "=========================================="
          echo "Step 7: Verifying Docker Installation"
          echo "=========================================="
          echo ""

          # Wait a moment for Docker to fully start
          echo "â³ Waiting for Docker daemon to be ready..."
          sleep 3

          # Test Docker
          echo "ðŸ” Testing Docker installation..."
          DOCKER_VERSION=$(ssh -p $DB_VM_SSH_PORT -i ~/.ssh/db_vm_key "$DB_VM_USER@$DB_HOST" "sudo docker --version" 2>/dev/null || echo "")
          COMPOSE_VERSION=$(ssh -p $DB_VM_SSH_PORT -i ~/.ssh/db_vm_key "$DB_VM_USER@$DB_HOST" "sudo docker compose version" 2>/dev/null || echo "")

          if [ -n "$DOCKER_VERSION" ] && [ -n "$COMPOSE_VERSION" ]; then
            echo "   âœ… $DOCKER_VERSION"
            echo "   âœ… $COMPOSE_VERSION"
          else
            echo "   âŒ Docker installation verification failed"
            rm -rf "$DOCKER_TEMP" ~/.ssh/db_vm_key
            exit 1
          fi
          echo ""

          # Test Docker daemon
          echo "ðŸ” Testing Docker daemon..."
          if ssh -p $DB_VM_SSH_PORT -i ~/.ssh/db_vm_key "$DB_VM_USER@$DB_HOST" "sudo docker ps > /dev/null 2>&1"; then
            echo "   âœ… Docker daemon is running"
          else
            echo "   âŒ Docker daemon is not responding"
            rm -rf "$DOCKER_TEMP" ~/.ssh/db_vm_key
            exit 1
          fi
          echo ""

          #####################################################################
          # Step 8: Cleanup
          #####################################################################
          echo "=========================================="
          echo "Step 8: Cleaning Up"
          echo "=========================================="
          echo ""

          # Remove local packages
          echo "ðŸ§¹ Removing local package files..."
          rm -rf "$DOCKER_TEMP"
          echo "   âœ… Local packages removed: $DOCKER_TEMP"

          # Remove remote packages
          echo "ðŸ§¹ Removing package files from DB VM..."
          ssh -p $DB_VM_SSH_PORT -i ~/.ssh/db_vm_key "$DB_VM_USER@$DB_HOST" "rm /tmp/*.deb" > /dev/null 2>&1 || true
          echo "   âœ… Remote packages removed"

          # Remove SSH key
          rm -f ~/.ssh/db_vm_key
          echo "   âœ… Temporary SSH key removed"
          echo ""

          echo "=========================================="
          echo "âœ… Docker Installation Complete"
          echo "=========================================="
          echo ""
          echo "Docker Engine and Docker Compose have been successfully installed on DB VM."
          echo ""
          echo "Note: User $DB_VM_USER has been added to 'docker' group."
          echo "      A re-login is required for group membership to take effect."
          echo "      Until then, Docker commands require 'sudo'."
          echo ""

      #########################################################################
      # STEP 8: Prepare and Transfer Docker Images to DB VM (Offline Setup)
      #########################################################################
      - name: Prepare and Transfer Docker Images to DB VM
        if: github.event.inputs.action == 'setup' || github.event.inputs.action == 'full-check'
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_VM_USER: ${{ secrets.DB_VM_USER }}
          DB_VM_SSH_KEY: ${{ secrets.DB_VM_SSH_KEY }}
          DB_VM_SSH_PORT: ${{ secrets.DB_VM_SSH_PORT }}
        run: |
          echo "=========================================="
          echo "Preparing Docker Images for DB VM"
          echo "=========================================="
          echo ""
          echo "â„¹ï¸  DB VM is offline and cannot pull images directly."
          echo "   Images will be pulled on AP VM, then transferred via SCP."
          echo ""

          # Mask SSH key
          echo "::add-mask::$DB_VM_SSH_KEY"

          # Define images to transfer (match docker-compose.prod-db.yml)
          POSTGRES_IMAGE="postgres:15-alpine"
          MINIO_IMAGE="minio/minio:latest"

          # Temporary directory for tar files
          TEMP_DIR="/tmp/db-images-$$"
          mkdir -p "$TEMP_DIR"

          #####################################################################
          # Step 8.1: Pull Docker Images on AP VM
          #####################################################################
          echo "=========================================="
          echo "Step 1/6: Pulling Docker Images"
          echo "=========================================="
          echo ""

          echo "ðŸ“¦ Pulling $POSTGRES_IMAGE..."
          if docker pull "$POSTGRES_IMAGE"; then
            echo "   âœ… PostgreSQL image pulled successfully"
          else
            echo "   âŒ Failed to pull PostgreSQL image"
            rm -rf "$TEMP_DIR"
            exit 1
          fi
          echo ""

          echo "ðŸ“¦ Pulling $MINIO_IMAGE..."
          if docker pull "$MINIO_IMAGE"; then
            echo "   âœ… MinIO image pulled successfully"
          else
            echo "   âŒ Failed to pull MinIO image"
            rm -rf "$TEMP_DIR"
            exit 1
          fi
          echo ""

          #####################################################################
          # Step 8.2: Save Images as Tar Files
          #####################################################################
          echo "=========================================="
          echo "Step 2/6: Saving Images as Tar Files"
          echo "=========================================="
          echo ""

          echo "ðŸ’¾ Saving $POSTGRES_IMAGE to tar..."
          if docker save "$POSTGRES_IMAGE" -o "$TEMP_DIR/postgres.tar"; then
            POSTGRES_SIZE=$(du -h "$TEMP_DIR/postgres.tar" | cut -f1)
            echo "   âœ… Saved: $TEMP_DIR/postgres.tar ($POSTGRES_SIZE)"
          else
            echo "   âŒ Failed to save PostgreSQL image"
            rm -rf "$TEMP_DIR"
            exit 1
          fi
          echo ""

          echo "ðŸ’¾ Saving $MINIO_IMAGE to tar..."
          if docker save "$MINIO_IMAGE" -o "$TEMP_DIR/minio.tar"; then
            MINIO_SIZE=$(du -h "$TEMP_DIR/minio.tar" | cut -f1)
            echo "   âœ… Saved: $TEMP_DIR/minio.tar ($MINIO_SIZE)"
          else
            echo "   âŒ Failed to save MinIO image"
            rm -rf "$TEMP_DIR"
            exit 1
          fi
          echo ""

          #####################################################################
          # Step 8.3: Setup SSH Connection to DB VM
          #####################################################################
          echo "=========================================="
          echo "Step 3/6: Setting up SSH Connection"
          echo "=========================================="
          echo ""

          # Create SSH directory
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # Write SSH private key
          echo "$DB_VM_SSH_KEY" > ~/.ssh/db_vm_key
          chmod 600 ~/.ssh/db_vm_key

          # Add DB_HOST to known_hosts (disable strict host key checking for automation)
          if [ ! -f ~/.ssh/known_hosts ] || ! grep -q "$DB_HOST" ~/.ssh/known_hosts; then
            echo "   Adding $DB_HOST to known_hosts..."
            ssh-keyscan -p $DB_VM_SSH_PORT -H "$DB_HOST" >> ~/.ssh/known_hosts 2>/dev/null
          fi

          # Test SSH connection
          echo "   Testing SSH connection to $DB_VM_USER@$DB_HOST..."
          if ssh -p $DB_VM_SSH_PORT -i ~/.ssh/db_vm_key -o ConnectTimeout=10 -o StrictHostKeyChecking=no "$DB_VM_USER@$DB_HOST" "echo 'SSH connection successful'" 2>/dev/null; then
            echo "   âœ… SSH connection verified"
          else
            echo "   âŒ SSH connection failed"
            echo ""
            echo "Please verify:"
            echo "1. DB_VM_SSH_KEY secret is correct"
            echo "2. DB_VM_USER secret is correct"
            echo "3. Public key is added to $DB_VM_USER@$DB_HOST:~/.ssh/authorized_keys"
            echo "4. DB VM allows SSH connections from this AP VM"
            rm -rf "$TEMP_DIR" ~/.ssh/db_vm_key
            exit 1
          fi
          echo ""

          #####################################################################
          # Step 8.4: Check if Images Already Exist on DB VM
          #####################################################################
          echo "=========================================="
          echo "Step 4/6: Checking Existing Images on DB VM"
          echo "=========================================="
          echo ""

          POSTGRES_EXISTS=$(ssh -p $DB_VM_SSH_PORT -i ~/.ssh/db_vm_key "$DB_VM_USER@$DB_HOST" "sudo docker images -q $POSTGRES_IMAGE 2>/dev/null" || echo "")
          MINIO_EXISTS=$(ssh -p $DB_VM_SSH_PORT -i ~/.ssh/db_vm_key "$DB_VM_USER@$DB_HOST" "sudo docker images -q $MINIO_IMAGE 2>/dev/null" || echo "")

          if [ -n "$POSTGRES_EXISTS" ]; then
            echo "   â„¹ï¸  $POSTGRES_IMAGE already exists on DB VM (skipping transfer)"
            SKIP_POSTGRES=true
          else
            echo "   âš ï¸  $POSTGRES_IMAGE not found on DB VM (will transfer)"
            SKIP_POSTGRES=false
          fi

          if [ -n "$MINIO_EXISTS" ]; then
            echo "   â„¹ï¸  $MINIO_IMAGE already exists on DB VM (skipping transfer)"
            SKIP_MINIO=true
          else
            echo "   âš ï¸  $MINIO_IMAGE not found on DB VM (will transfer)"
            SKIP_MINIO=false
          fi
          echo ""

          #####################################################################
          # Step 8.5: Transfer and Load Images on DB VM
          #####################################################################
          echo "=========================================="
          echo "Step 5/6: Transferring Images to DB VM"
          echo "=========================================="
          echo ""

          # Transfer PostgreSQL image
          if [ "$SKIP_POSTGRES" = false ]; then
            echo "ðŸ“¤ Transferring postgres.tar to DB VM ($POSTGRES_SIZE)..."
            if scp -P $DB_VM_SSH_PORT -i ~/.ssh/db_vm_key -o StrictHostKeyChecking=no "$TEMP_DIR/postgres.tar" "$DB_VM_USER@$DB_HOST:/tmp/postgres.tar"; then
              echo "   âœ… Transfer complete"

              echo "   Loading image on DB VM..."
              if ssh -p $DB_VM_SSH_PORT -i ~/.ssh/db_vm_key "$DB_VM_USER@$DB_HOST" "sudo docker load -i /tmp/postgres.tar"; then
                echo "   âœ… PostgreSQL image loaded successfully"

                # Cleanup remote tar file
                ssh -p $DB_VM_SSH_PORT -i ~/.ssh/db_vm_key "$DB_VM_USER@$DB_HOST" "rm /tmp/postgres.tar"
              else
                echo "   âŒ Failed to load PostgreSQL image on DB VM"
              fi
            else
              echo "   âŒ Failed to transfer postgres.tar"
            fi
            echo ""
          fi

          # Transfer MinIO image
          if [ "$SKIP_MINIO" = false ]; then
            echo "ðŸ“¤ Transferring minio.tar to DB VM ($MINIO_SIZE)..."
            if scp -P $DB_VM_SSH_PORT -i ~/.ssh/db_vm_key -o StrictHostKeyChecking=no "$TEMP_DIR/minio.tar" "$DB_VM_USER@$DB_HOST:/tmp/minio.tar"; then
              echo "   âœ… Transfer complete"

              echo "   Loading image on DB VM..."
              if ssh -p $DB_VM_SSH_PORT -i ~/.ssh/db_vm_key "$DB_VM_USER@$DB_HOST" "sudo docker load -i /tmp/minio.tar"; then
                echo "   âœ… MinIO image loaded successfully"

                # Cleanup remote tar file
                ssh -p $DB_VM_SSH_PORT -i ~/.ssh/db_vm_key "$DB_VM_USER@$DB_HOST" "rm /tmp/minio.tar"
              else
                echo "   âŒ Failed to load MinIO image on DB VM"
              fi
            else
              echo "   âŒ Failed to transfer minio.tar"
            fi
            echo ""
          fi

          #####################################################################
          # Step 8.6: Verify Images on DB VM
          #####################################################################
          echo "=========================================="
          echo "Step 6/6: Verifying Images on DB VM"
          echo "=========================================="
          echo ""

          echo "ðŸ” Checking loaded images on DB VM..."
          IMAGES_OUTPUT=$(ssh -p $DB_VM_SSH_PORT -i ~/.ssh/db_vm_key "$DB_VM_USER@$DB_HOST" "sudo docker images --format 'table {{.Repository}}:{{.Tag}}\t{{.Size}}' | grep -E '(postgres|minio)'" || echo "")

          if [ -n "$IMAGES_OUTPUT" ]; then
            echo "$IMAGES_OUTPUT"
            echo ""
            echo "âœ… Required images are available on DB VM"
          else
            echo "âš ï¸  Warning: Could not verify images on DB VM"
          fi
          echo ""

          #####################################################################
          # Cleanup
          #####################################################################
          echo "=========================================="
          echo "Cleaning Up Temporary Files"
          echo "=========================================="
          echo ""

          # Remove local tar files
          rm -rf "$TEMP_DIR"
          echo "   âœ… Local tar files removed: $TEMP_DIR"

          # Remove SSH key
          rm -f ~/.ssh/db_vm_key
          echo "   âœ… Temporary SSH key removed"
          echo ""

          echo "=========================================="
          echo "âœ… Docker Images Prepared for DB VM"
          echo "=========================================="
          echo ""
          echo "DB VM is now ready with required Docker images:"
          echo "- $POSTGRES_IMAGE"
          echo "- $MINIO_IMAGE"
          echo ""
          echo "Next: Admin can start DB services with:"
          echo "  ssh -p $DB_VM_SSH_PORT $DB_VM_USER@$DB_HOST"
          echo "  cd /srv/naass/app/naass"
          echo "  docker compose -f docker-compose.prod-db.yml up -d"
          echo ""

      #########################################################################
      # STEP 9: Final Summary
      #########################################################################
      - name: Display Summary
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "ðŸŽ‰ Environment Setup Summary"
          echo "=========================================="
          echo ""
          echo "Action performed: ${{ github.event.inputs.action }}"
          echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo ""

          if [ "${{ github.event.inputs.action }}" = "validate" ]; then
            echo "âœ… Validation completed"
            echo ""
            echo "Next steps:"
            echo "1. Review validation results above"
            echo "2. Fix any warnings or errors"
            echo "3. Run 'setup' action to create directories and .env file"
            echo "4. Deploy application with: docker compose -f docker-compose.prod.yml up -d"
          elif [ "${{ github.event.inputs.action }}" = "setup" ]; then
            echo "âœ… Setup completed"
            echo ""
            echo "Next steps:"
            echo "1. Review .env.prod file: cat .env.prod"
            echo "2. Ensure .env.prod is not committed: git status"
            echo "3. Verify directory structure: ls -la /opt/scholarship/"
            echo "4. Deploy application with: docker compose -f docker-compose.prod.yml up -d"
          else
            echo "âœ… Full check and setup completed"
            echo ""
            echo "Your environment is ready for deployment!"
            echo ""
            echo "Next steps:"
            echo "1. Review all checks passed above"
            echo "2. Deploy application:"
            echo "   docker compose -f docker-compose.prod.yml up -d"
            echo "3. Monitor deployment:"
            echo "   docker compose -f docker-compose.prod.yml logs -f"
            echo "4. Verify services:"
            echo "   docker compose -f docker-compose.prod.yml ps"
            echo "   curl https://${{ secrets.DOMAIN }}/health"
          fi

          echo ""
          echo "=========================================="
          echo "ðŸ“š Documentation"
          echo "=========================================="
          echo ""
          echo "For more information, see:"
          echo "- Installation Manual: .github/production-workflows-examples/IT-BACKUP-TRANSFER-GUIDE.md"
          echo "- Secrets Setup: .github/production-workflows-examples/SECRETS-SETUP-GUIDE.md"
          echo "- GitHub Actions: .github/production-workflows-examples/README.md"
          echo ""

      #########################################################################
      # STEP 10: Post-Setup Security Reminder
      #########################################################################
      - name: Security Reminder
        if: github.event.inputs.action == 'setup' || github.event.inputs.action == 'full-check'
        run: |
          echo ""
          echo "=========================================="
          echo "ðŸ” Security Reminders"
          echo "=========================================="
          echo ""
          echo "âœ… .env.prod file permissions: 600 (owner only)"
          echo "âš ï¸  Ensure .env.prod is in .gitignore"
          echo "âš ï¸  Never commit .env.prod to version control"
          echo "âš ï¸  Rotate secrets regularly (every 90 days recommended)"
          echo "âš ï¸  Use strong passwords (16+ characters with mixed case, numbers, symbols)"
          echo ""
          echo "To verify .env.prod is not tracked:"
          echo "  git status | grep .env.prod"
          echo ""
          echo "If .env.prod appears in git status, add to .gitignore:"
          echo "  echo '.env.prod' >> .gitignore"
          echo "  git add .gitignore"
          echo "  git commit -m 'chore: add .env.prod to .gitignore'"
          echo ""
