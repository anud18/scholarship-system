name: Security Scanning

on:
  push:
    branches: [main, develop, application-gogo]
  pull_request:
    branches: [main, develop, application-gogo]
  schedule:
    # Run security scans daily at 3 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch:

env:
  NODE_VERSION: '22'
  PYTHON_VERSION: '3.11'

jobs:
  # Static Application Security Testing (SAST)
  sast-analysis:
    name: Static Security Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    
    strategy:
      matrix:
        component: [backend, frontend]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python (Backend)
        if: matrix.component == 'backend'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Setup Node.js (Frontend)
        if: matrix.component == 'frontend'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install security tools (Backend)
        if: matrix.component == 'backend'
        run: |
          pip install bandit safety semgrep
          # Install additional security tools
          pip install pip-audit

      - name: Install dependencies (Frontend)
        if: matrix.component == 'frontend'
        working-directory: ./frontend
        run: npm ci

      - name: Run Bandit (Python SAST)
        if: matrix.component == 'backend'
        working-directory: ./backend
        run: |
          echo "## ðŸ”’ Python Security Analysis (Bandit)" > security-report.md
          echo "" >> security-report.md
          
          # Run bandit and capture results
          if bandit -r app -f json -o bandit-report.json -ll; then
            echo "âœ… No high or medium severity issues found" >> security-report.md
          else
            echo "âš ï¸ Security issues detected:" >> security-report.md
            echo "" >> security-report.md
            echo "\`\`\`json" >> security-report.md
            cat bandit-report.json | jq '.results[] | {test_name, issue_text, line_number, filename}' >> security-report.md
            echo "\`\`\`" >> security-report.md
          fi
          echo "" >> security-report.md

      - name: Run Safety (Dependency Vulnerability Check)
        if: matrix.component == 'backend'
        working-directory: ./backend
        continue-on-error: true
        run: |
          echo "## ðŸ›¡ï¸ Dependency Vulnerability Check (Safety)" >> security-report.md
          echo "" >> security-report.md
          
          # Check for known vulnerabilities
          if safety check --json --output safety-report.json; then
            echo "âœ… No known vulnerabilities in dependencies" >> security-report.md
          else
            echo "âš ï¸ Vulnerable dependencies found:" >> security-report.md
            echo "" >> security-report.md
            if [ -f "safety-report.json" ]; then
              echo "\`\`\`json" >> security-report.md
              cat safety-report.json >> security-report.md
              echo "\`\`\`" >> security-report.md
            fi
          fi
          echo "" >> security-report.md

      - name: Run pip-audit
        if: matrix.component == 'backend'
        working-directory: ./backend
        continue-on-error: true
        run: |
          echo "## ðŸ” Advanced Dependency Audit (pip-audit)" >> security-report.md
          echo "" >> security-report.md
          
          if pip-audit --format=json --output=pip-audit-report.json; then
            echo "âœ… No vulnerabilities found by pip-audit" >> security-report.md
          else
            echo "âš ï¸ Vulnerabilities detected by pip-audit:" >> security-report.md
            echo "" >> security-report.md
            if [ -f "pip-audit-report.json" ]; then
              echo "\`\`\`json" >> security-report.md
              cat pip-audit-report.json | jq '.[] | {package, installed_version, vulnerability_id, fix_versions}' >> security-report.md
              echo "\`\`\`" >> security-report.md
            fi
          fi
          echo "" >> security-report.md

      - name: Run Semgrep (Advanced SAST)
        if: matrix.component == 'backend'
        working-directory: ./backend
        continue-on-error: true
        run: |
          echo "## ðŸŽ¯ Advanced Static Analysis (Semgrep)" >> security-report.md
          echo "" >> security-report.md
          
          # Run semgrep with security-focused rules
          if semgrep --config=auto --json --output=semgrep-report.json app/; then
            echo "âœ… No issues found by Semgrep" >> security-report.md
          else
            echo "âš ï¸ Security patterns detected:" >> security-report.md
            echo "" >> security-report.md
            if [ -f "semgrep-report.json" ]; then
              findings_count=$(jq '.results | length' semgrep-report.json)
              echo "**Found $findings_count potential issues**" >> security-report.md
              echo "" >> security-report.md
              echo "Top 5 critical findings:" >> security-report.md
              echo "\`\`\`" >> security-report.md
              cat semgrep-report.json | jq '.results[:5] | .[] | {rule_id: .check_id, message, severity, path}' >> security-report.md
              echo "\`\`\`" >> security-report.md
            fi
          fi
          echo "" >> security-report.md

      - name: Run npm audit (Frontend)
        if: matrix.component == 'frontend'
        working-directory: ./frontend
        continue-on-error: true
        run: |
          echo "## ðŸ“¦ Frontend Dependency Security (npm audit)" > security-report.md
          echo "" >> security-report.md
          
          if npm audit --json > npm-audit-report.json; then
            vulnerabilities=$(jq '.metadata.vulnerabilities | to_entries | map(select(.value > 0))' npm-audit-report.json)
            if [ "$vulnerabilities" = "[]" ]; then
              echo "âœ… No vulnerabilities found in frontend dependencies" >> security-report.md
            else
              echo "âš ï¸ Vulnerabilities found:" >> security-report.md
              echo "" >> security-report.md
              echo "| Severity | Count |" >> security-report.md
              echo "|----------|-------|" >> security-report.md
              jq -r '.metadata.vulnerabilities | to_entries[] | "| \(.key) | \(.value) |"' npm-audit-report.json >> security-report.md
              echo "" >> security-report.md
              echo "**Critical vulnerabilities:**" >> security-report.md
              echo "\`\`\`" >> security-report.md
              jq '.advisories | to_entries | map(select(.value.severity == "critical")) | .[0:3] | .[] | .value | {module_name, title, severity, overview}' npm-audit-report.json >> security-report.md
              echo "\`\`\`" >> security-report.md
            fi
          else
            echo "âš ï¸ npm audit found issues - check npm-audit-report.json for details" >> security-report.md
          fi
          echo "" >> security-report.md

      - name: Run ESLint Security Plugin (Frontend)
        if: matrix.component == 'frontend'
        working-directory: ./frontend
        continue-on-error: true
        run: |
          # Install security-focused ESLint plugins
          npm install --no-save eslint-plugin-security @typescript-eslint/eslint-plugin
          
          echo "## ðŸ” Frontend Code Security (ESLint Security)" >> security-report.md
          echo "" >> security-report.md
          
          # Create temporary ESLint config for security
          cat > .eslintrc.security.js << 'EOF'
          module.exports = {
            extends: ['next/core-web-vitals'],
            plugins: ['security'],
            rules: {
              'security/detect-object-injection': 'error',
              'security/detect-non-literal-regexp': 'error',
              'security/detect-unsafe-regex': 'error',
              'security/detect-buffer-noassert': 'error',
              'security/detect-child-process': 'error',
              'security/detect-disable-mustache-escape': 'error',
              'security/detect-eval-with-expression': 'error',
              'security/detect-no-csrf-before-method-override': 'error',
              'security/detect-non-literal-fs-filename': 'error',
              'security/detect-non-literal-require': 'error',
              'security/detect-pseudoRandomBytes': 'error',
            }
          };
          EOF
          
          if npx eslint . --config .eslintrc.security.js --format json --output-file eslint-security-report.json; then
            echo "âœ… No security issues found by ESLint" >> security-report.md
          else
            echo "âš ï¸ Security issues found:" >> security-report.md
            echo "" >> security-report.md
            echo "\`\`\`" >> security-report.md
            jq '.[] | select(.messages | length > 0) | {filePath, messages: .messages | map({ruleId, message, severity})}' eslint-security-report.json >> security-report.md
            echo "\`\`\`" >> security-report.md
          fi
          echo "" >> security-report.md

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports-${{ matrix.component }}
          path: |
            ${{ matrix.component }}/security-report.md
            ${{ matrix.component }}/bandit-report.json
            ${{ matrix.component }}/safety-report.json
            ${{ matrix.component }}/semgrep-report.json
            ${{ matrix.component }}/npm-audit-report.json
            ${{ matrix.component }}/eslint-security-report.json
          retention-days: 30

      - name: Generate SARIF format
        if: matrix.component == 'backend'
        working-directory: ./backend
        run: |
          # Convert bandit results to SARIF format
          if [ -f "bandit-report.json" ]; then
            # Install sarif converter
            pip install bandit[toml] sarif-om
            
            # Convert to SARIF
            bandit -r app -f sarif -o bandit-results.sarif -ll || true
          fi

      - name: Upload SARIF results to GitHub Security tab
        if: matrix.component == 'backend'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: backend/bandit-results.sarif
        continue-on-error: true

  # Container security scanning
  container-security:
    name: Container Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    strategy:
      matrix:
        component: [backend, frontend]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -t test-image:latest ./${{ matrix.component }}

      - name: Run Trivy container scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'test-image:latest'
          format: 'sarif'
          output: 'trivy-results-${{ matrix.component }}.sarif'

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './${{ matrix.component }}'
          format: 'json'
          output: 'trivy-fs-results-${{ matrix.component }}.json'

      - name: Generate container security report
        run: |
          echo "## ðŸ³ Container Security Report (${{ matrix.component }})" > container-security-report-${{ matrix.component }}.md
          echo "" >> container-security-report-${{ matrix.component }}.md
          
          # Parse Trivy results
          if [ -f "trivy-fs-results-${{ matrix.component }}.json" ]; then
            critical=$(jq '.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL") | .VulnerabilityID' trivy-fs-results-${{ matrix.component }}.json | wc -l)
            high=$(jq '.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH") | .VulnerabilityID' trivy-fs-results-${{ matrix.component }}.json | wc -l)
            medium=$(jq '.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM") | .VulnerabilityID' trivy-fs-results-${{ matrix.component }}.json | wc -l)
            
            echo "### Vulnerability Summary" >> container-security-report-${{ matrix.component }}.md
            echo "| Severity | Count | Status |" >> container-security-report-${{ matrix.component }}.md
            echo "|----------|-------|--------|" >> container-security-report-${{ matrix.component }}.md
            echo "| Critical | $critical | $([ $critical -eq 0 ] && echo "âœ…" || echo "âŒ") |" >> container-security-report-${{ matrix.component }}.md
            echo "| High | $high | $([ $high -eq 0 ] && echo "âœ…" || echo "âš ï¸") |" >> container-security-report-${{ matrix.component }}.md
            echo "| Medium | $medium | $([ $medium -lt 10 ] && echo "âœ…" || echo "âš ï¸") |" >> container-security-report-${{ matrix.component }}.md
            echo "" >> container-security-report-${{ matrix.component }}.md
            
            # List critical vulnerabilities
            if [ $critical -gt 0 ]; then
              echo "### Critical Vulnerabilities" >> container-security-report-${{ matrix.component }}.md
              echo "\`\`\`" >> container-security-report-${{ matrix.component }}.md
              jq '.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL") | {VulnerabilityID, PkgName, InstalledVersion, FixedVersion, Title}' trivy-fs-results-${{ matrix.component }}.json >> container-security-report-${{ matrix.component }}.md
              echo "\`\`\`" >> container-security-report-${{ matrix.component }}.md
              echo "" >> container-security-report-${{ matrix.component }}.md
            fi
            
            # Security recommendations
            echo "### Recommendations" >> container-security-report-${{ matrix.component }}.md
            if [ $critical -gt 0 ] || [ $high -gt 5 ]; then
              echo "- ðŸš¨ **High Priority**: Address critical and high severity vulnerabilities immediately" >> container-security-report-${{ matrix.component }}.md
              echo "- ðŸ“¦ Update base images and dependencies to latest versions" >> container-security-report-${{ matrix.component }}.md
              echo "- ðŸ”’ Consider using distroless or minimal base images" >> container-security-report-${{ matrix.component }}.md
            else
              echo "- âœ… Container security is in good state" >> container-security-report-${{ matrix.component }}.md
              echo "- ðŸ“… Continue regular security scanning and updates" >> container-security-report-${{ matrix.component }}.md
            fi
          fi

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results-${{ matrix.component }}.sarif'

      - name: Upload container security artifacts
        uses: actions/upload-artifact@v4
        with:
          name: container-security-${{ matrix.component }}
          path: |
            trivy-results-${{ matrix.component }}.sarif
            trivy-fs-results-${{ matrix.component }}.json
            container-security-report-${{ matrix.component }}.md
          retention-days: 30

  # Secret scanning
  secret-detection:
    name: Secret Detection
    permissions:
      contents: read
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified

      - name: Run GitLeaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Custom secret patterns check
        run: |
          echo "## ðŸ” Secret Detection Report" > secret-detection-report.md
          echo "" >> secret-detection-report.md
          
          # Define patterns to check
          patterns=(
            "password\s*=\s*['\"][^'\"]{8,}['\"]"
            "secret\s*=\s*['\"][^'\"]{16,}['\"]"
            "api_key\s*=\s*['\"][^'\"]{16,}['\"]"
            "private_key"
            "BEGIN RSA PRIVATE KEY"
            "BEGIN OPENSSH PRIVATE KEY"
            "sk-[a-zA-Z0-9]{40,}"
            "xoxb-[0-9]+-[0-9]+-[0-9]+-[a-zA-Z0-9]+"
          )
          
          found_secrets=false
          for pattern in "${patterns[@]}"; do
            if grep -r -i -n -E "$pattern" . --exclude-dir=.git --exclude-dir=node_modules --exclude-dir=.next --exclude="*.md"; then
              found_secrets=true
              echo "âš ï¸ Potential secret pattern found: $pattern" >> secret-detection-report.md
            fi
          done
          
          if [ "$found_secrets" = false ]; then
            echo "âœ… No obvious secret patterns detected" >> secret-detection-report.md
          fi
          echo "" >> secret-detection-report.md
          
          echo "### Security Best Practices" >> secret-detection-report.md
          echo "- ðŸ” Use environment variables for secrets" >> secret-detection-report.md
          echo "- ðŸ”’ Use secret management services (AWS Secrets Manager, Azure Key Vault, etc.)" >> secret-detection-report.md
          echo "- ðŸš« Never commit secrets to git" >> secret-detection-report.md
          echo "- ðŸ”„ Rotate secrets regularly" >> secret-detection-report.md
          echo "- ðŸ“ Use .gitignore to exclude sensitive files" >> secret-detection-report.md

      - name: Upload secret detection results
        uses: actions/upload-artifact@v4
        with:
          name: secret-detection-results
          path: secret-detection-report.md
          retention-days: 30

  # License compliance check
  license-compliance:
    name: License Compliance
    permissions:
      contents: read
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install license checking tools
        run: |
          pip install pip-licenses
          npm install -g license-checker

      - name: Check Python licenses
        working-directory: ./backend
        run: |
          pip install -r requirements.txt
          echo "## ðŸ“„ License Compliance Report" > ../license-compliance-report.md
          echo "" >> ../license-compliance-report.md
          echo "### Python Dependencies" >> ../license-compliance-report.md
          echo "" >> ../license-compliance-report.md
          
          pip-licenses --format=markdown --output-file=python-licenses.md
          cat python-licenses.md >> ../license-compliance-report.md
          echo "" >> ../license-compliance-report.md
          
          # Check for restrictive licenses
          restrictive_licenses=("GPL-3.0" "AGPL-3.0" "GPL-2.0" "LGPL-3.0")
          for license in "${restrictive_licenses[@]}"; do
            if pip-licenses | grep -i "$license"; then
              echo "âš ï¸ **Warning**: Found potentially restrictive license: $license" >> ../license-compliance-report.md
            fi
          done

      - name: Check Node.js licenses
        working-directory: ./frontend
        run: |
          npm ci
          echo "" >> ../license-compliance-report.md
          echo "### Frontend Dependencies" >> ../license-compliance-report.md
          echo "" >> ../license-compliance-report.md
          
          license-checker --markdown > ../frontend-licenses.md
          cat ../frontend-licenses.md >> ../license-compliance-report.md
          echo "" >> ../license-compliance-report.md
          
          # Check for restrictive licenses
          if license-checker --onlyAllow 'Apache-2.0;BSD-2-Clause;BSD-3-Clause;MIT;ISC;Unlicense;WTFPL' --summary; then
            echo "âœ… All licenses are permissive" >> ../license-compliance-report.md
          else
            echo "âš ï¸ Some licenses may require review" >> ../license-compliance-report.md
          fi

      - name: Upload license compliance report
        uses: actions/upload-artifact@v4
        with:
          name: license-compliance-report
          path: |
            license-compliance-report.md
            frontend-licenses.md
            backend/python-licenses.md
          retention-days: 30

  # Security summary and notifications
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs: [sast-analysis, container-security, secret-detection, license-compliance]
    if: always()
    
    steps:
      - name: Download security reports
        uses: actions/download-artifact@v4
        with:
          path: security-reports

      - name: Create comprehensive security summary
        run: |
          echo "## ðŸ›¡ï¸ Security Scanning Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Status" >> $GITHUB_STEP_SUMMARY
          echo "| Security Check | Status | Component |" >> $GITHUB_STEP_SUMMARY
          echo "|----------------|--------|-----------|" >> $GITHUB_STEP_SUMMARY
          echo "| SAST Analysis | ${{ needs.sast-analysis.result }} | Backend & Frontend |" >> $GITHUB_STEP_SUMMARY
          echo "| Container Security | ${{ needs.container-security.result }} | Docker Images |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Detection | ${{ needs.secret-detection.result }} | Repository |" >> $GITHUB_STEP_SUMMARY
          echo "| License Compliance | ${{ needs.license-compliance.result }} | Dependencies |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Security Checklist" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”’ **SAST**: Static code analysis for security vulnerabilities" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ›¡ï¸ **Dependencies**: Check for known vulnerabilities in packages" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ³ **Containers**: Scan Docker images for security issues" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” **Secrets**: Detect accidentally committed secrets" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“„ **Licenses**: Verify compliance with license requirements" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Determine overall security status
          if [[ "${{ needs.sast-analysis.result }}" == "success" && \
                "${{ needs.container-security.result }}" == "success" && \
                "${{ needs.secret-detection.result }}" == "success" && \
                "${{ needs.license-compliance.result }}" == "success" ]]; then
            echo "### âœ… **Security Status: PASS**" >> $GITHUB_STEP_SUMMARY
            echo "All security checks completed successfully! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ **Security Status: NEEDS ATTENTION**" >> $GITHUB_STEP_SUMMARY
            echo "Some security checks failed or found issues. Please review the detailed reports." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š **View detailed security reports in the job artifacts**" >> $GITHUB_STEP_SUMMARY

      - name: Notify security team on critical findings
        if: needs.sast-analysis.result == 'failure' || needs.container-security.result == 'failure'
        run: |
          echo "ðŸš¨ Critical security issues detected!"
          echo "Repository: ${{ github.repository }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          # Add Slack/email notification logic here

      - name: Create security badge
        run: |
          if [[ "${{ needs.sast-analysis.result }}" == "success" && \
                "${{ needs.container-security.result }}" == "success" && \
                "${{ needs.secret-detection.result }}" == "success" ]]; then
            badge_color="brightgreen"
            badge_status="passing"
          else
            badge_color="red"
            badge_status="failing"
          fi
          
          # Create security status badge
          curl -s "https://img.shields.io/badge/security-$badge_status-$badge_color.svg" > security-badge.svg

      - name: Upload security badge
        uses: actions/upload-artifact@v4
        with:
          name: security-badge
          path: security-badge.svg
          retention-days: 30