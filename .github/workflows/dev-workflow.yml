name: Development Workflow

on:
  pull_request:
    branches: [main, develop, application-gogo]
    types: [opened, synchronize, reopened, labeled, unlabeled]
  pull_request_review:
    types: [submitted]
  issue_comment:
    types: [created]

env:
  NODE_VERSION: '22'
  PYTHON_VERSION: '3.11'

jobs:
  # Auto-label PRs based on changes
  pr-labeling:
    name: Auto Label PR
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action != 'closed'
    permissions:
      pull-requests: write
      contents: read
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Label based on files changed
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml

      - name: Calculate PR size
        id: pr-size
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            
            let additions = 0;
            let deletions = 0;
            let changedFiles = 0;
            
            files.forEach(file => {
              additions += file.additions;
              deletions += file.deletions;
              changedFiles++;
            });
            
            const totalChanges = additions + deletions;
            let sizeLabel = '';
            
            if (totalChanges < 50) sizeLabel = 'size/XS';
            else if (totalChanges < 200) sizeLabel = 'size/S';
            else if (totalChanges < 500) sizeLabel = 'size/M';
            else if (totalChanges < 1000) sizeLabel = 'size/L';
            else sizeLabel = 'size/XL';
            
            // Add size label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: [sizeLabel]
            });
            
            // Add warning comment for large PRs
            if (totalChanges > 500) {
              const warningMessage = [
                '‚ö†Ô∏è **Large PR Detected**',
                '',
                `This PR contains ${totalChanges} line changes across ${changedFiles} files. Consider:`,
                '- Breaking it into smaller, focused PRs',
                '- Ensuring adequate test coverage',
                '- Adding detailed description of changes',
                '',
                '**Changes:**',
                `- üìù ${additions} additions`,
                `- üóëÔ∏è ${deletions} deletions`,
                `- üìÅ ${changedFiles} files changed`
              ].join('\n');
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: warningMessage
              });
            }

  # Check for merge conflicts
  conflict-check:
    name: Conflict Detection
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for merge conflicts
        id: conflict-check
        run: |
          git fetch origin ${{ github.base_ref }}
          
          # Check if PR branch can be merged cleanly
          if git merge-tree $(git merge-base HEAD origin/${{ github.base_ref }}) HEAD origin/${{ github.base_ref }} | grep -q '<<<<<<<'; then
            echo "conflicts=true" >> $GITHUB_OUTPUT
            echo "Merge conflicts detected"
            exit 1
          else
            echo "conflicts=false" >> $GITHUB_OUTPUT
            echo "No merge conflicts"
          fi

      - name: Comment on conflicts
        if: failure() && steps.conflict-check.outputs.conflicts == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const conflictMessage = [
              'üö® **Merge Conflicts Detected**',
              '',
              'This PR has merge conflicts with the base branch. Please resolve them before merging:',
              '',
              '```bash',
              'git checkout ${{ github.head_ref }}',
              'git fetch origin',
              'git merge origin/${{ github.base_ref }}',
              '# Resolve conflicts',
              'git commit',
              'git push',
              '```',
              '',
              'The CI will re-run automatically after conflicts are resolved.'
            ].join('\n');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: conflictMessage
            });

  # Code quality checks
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    strategy:
      matrix:
        component: [backend, frontend]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python (Backend)
        if: matrix.component == 'backend'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Setup Node.js (Frontend)
        if: matrix.component == 'frontend'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies (Backend)
        if: matrix.component == 'backend'
        working-directory: ./backend
        run: |
          pip install -r requirements.txt
          pip install black isort flake8 mypy pytest-cov

      - name: Install dependencies (Frontend)
        if: matrix.component == 'frontend'
        working-directory: ./frontend
        run: npm ci

      - name: Run backend quality checks
        if: matrix.component == 'backend'
        working-directory: ./backend
        run: |
          echo "## üêç Backend Code Quality Results" >> quality-report.md
          echo "" >> quality-report.md
          
          # Black formatting check
          echo "### Code Formatting (Black)" >> quality-report.md
          if black --check --diff .; then
            echo "‚úÖ Code is properly formatted" >> quality-report.md
          else
            echo "‚ùå Code formatting issues found" >> quality-report.md
            echo "\`\`\`diff" >> quality-report.md
            black --check --diff . >> quality-report.md || true
            echo "\`\`\`" >> quality-report.md
          fi
          echo "" >> quality-report.md
          
          # Import sorting check
          echo "### Import Sorting (isort)" >> quality-report.md
          if isort --check-only --diff .; then
            echo "‚úÖ Imports are properly sorted" >> quality-report.md
          else
            echo "‚ùå Import sorting issues found" >> quality-report.md
            echo "\`\`\`diff" >> quality-report.md
            isort --check-only --diff . >> quality-report.md || true
            echo "\`\`\`" >> quality-report.md
          fi
          echo "" >> quality-report.md
          
          # Flake8 style check
          echo "### Code Style (Flake8)" >> quality-report.md
          if flake8 . --count --statistics --format='%(path)s:%(row)d:%(col)d: %(code)s %(text)s'; then
            echo "‚úÖ No style issues found" >> quality-report.md
          else
            echo "‚ùå Style issues found" >> quality-report.md
          fi
          echo "" >> quality-report.md
          
          # Type checking
          echo "### Type Checking (MyPy)" >> quality-report.md
          if mypy app --ignore-missing-imports; then
            echo "‚úÖ No type errors found" >> quality-report.md
          else
            echo "‚ö†Ô∏è Type checking completed with warnings" >> quality-report.md
          fi

      - name: Run frontend quality checks
        if: matrix.component == 'frontend'
        working-directory: ./frontend
        run: |
          echo "## ‚öõÔ∏è Frontend Code Quality Results" >> quality-report.md
          echo "" >> quality-report.md
          
          # ESLint check
          echo "### Linting (ESLint)" >> quality-report.md
          if npm run lint; then
            echo "‚úÖ No linting errors found" >> quality-report.md
          else
            echo "‚ùå Linting errors found" >> quality-report.md
          fi
          echo "" >> quality-report.md
          
          # Prettier formatting check
          echo "### Code Formatting (Prettier)" >> quality-report.md
          if npx prettier --check "**/*.{js,jsx,ts,tsx,json,css,md}"; then
            echo "‚úÖ Code is properly formatted" >> quality-report.md
          else
            echo "‚ùå Code formatting issues found" >> quality-report.md
          fi
          echo "" >> quality-report.md
          
          # TypeScript check
          echo "### Type Checking (TypeScript)" >> quality-report.md
          if npx tsc --noEmit; then
            echo "‚úÖ No type errors found" >> quality-report.md
          else
            echo "‚ùå TypeScript errors found" >> quality-report.md
          fi

      - name: Upload quality report
        uses: actions/upload-artifact@v4
        with:
          name: quality-report-${{ matrix.component }}
          path: ${{ matrix.component }}/quality-report.md
          retention-days: 7

  # Bundle size analysis for frontend
  bundle-analysis:
    name: Bundle Size Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build for production
        working-directory: ./frontend
        run: npm run build

      - name: Analyze bundle size
        working-directory: ./frontend
        run: |
          # Install bundle analyzer
          npm install -g @next/bundle-analyzer
          
          # Create bundle analysis report
          echo "## üì¶ Bundle Size Analysis" > bundle-report.md
          echo "" >> bundle-report.md
          
          # Get build output size
          if [ -d ".next/static" ]; then
            total_size=$(du -sh .next/static | cut -f1)
            echo "**Total Bundle Size:** $total_size" >> bundle-report.md
            echo "" >> bundle-report.md
          fi
          
          # List largest files
          echo "### Largest Files:" >> bundle-report.md
          echo "\`\`\`" >> bundle-report.md
          find .next/static -name "*.js" -type f -exec du -h {} + | sort -hr | head -10 >> bundle-report.md
          echo "\`\`\`" >> bundle-report.md
          
          # Check for bundle size limits
          js_size=$(find .next/static -name "*.js" -type f -exec cat {} + | wc -c)
          js_size_mb=$((js_size / 1024 / 1024))
          
          echo "" >> bundle-report.md
          if [ $js_size_mb -gt 5 ]; then
            echo "‚ö†Ô∏è **Warning:** JavaScript bundle size ($js_size_mb MB) exceeds recommended 5MB limit" >> bundle-report.md
          else
            echo "‚úÖ JavaScript bundle size ($js_size_mb MB) is within recommended limits" >> bundle-report.md
          fi

      - name: Comment bundle analysis
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const report = fs.readFileSync('frontend/bundle-report.md', 'utf8');
              
              // Find existing bundle comment
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });
              
              const botComment = comments.find(comment => 
                comment.user.type === 'Bot' && comment.body.includes('Bundle Size Analysis')
              );
              
              if (botComment) {
                // Update existing comment
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: report
                });
              } else {
                // Create new comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: report
                });
              }
            } catch (error) {
              console.log('Bundle report not found, skipping comment');
            }

  # Auto-assign reviewers based on code changes
  reviewer-assignment:
    name: Auto-assign Reviewers
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    permissions:
      pull-requests: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Auto-assign reviewers
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            
            const reviewers = new Set();
            
            // Add reviewers based on file paths
            files.forEach(file => {
              if (file.filename.startsWith('backend/')) {
                reviewers.add('backend-team'); // Replace with actual username/team
              }
              if (file.filename.startsWith('frontend/')) {
                reviewers.add('frontend-team'); // Replace with actual username/team
              }
              if (file.filename.includes('docker') || file.filename.includes('yml')) {
                reviewers.add('devops-team'); // Replace with actual username/team
              }
              if (file.filename.includes('test')) {
                reviewers.add('qa-team'); // Replace with actual username/team
              }
            });
            
            // Convert to array and filter out author
            const reviewerList = Array.from(reviewers).filter(reviewer => 
              reviewer !== context.payload.pull_request.user.login
            );
            
            if (reviewerList.length > 0) {
              try {
                await github.rest.pulls.requestReviewers({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: context.issue.number,
                  reviewers: reviewerList.filter(r => !r.includes('-team')), // Individual reviewers
                  team_reviewers: reviewerList.filter(r => r.includes('-team')).map(r => r.replace('-team', '')) // Team reviewers
                });
              } catch (error) {
                console.log('Could not assign reviewers:', error.message);
              }
            }

  # Dependabot auto-merge for minor updates
  dependabot-auto-merge:
    name: Auto-merge Dependabot
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]' && github.event_name == 'pull_request'
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Dependabot metadata
        id: dependabot-metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto-merge minor and patch updates
        if: steps.dependabot-metadata.outputs.update-type == 'version-update:semver-minor' || steps.dependabot-metadata.outputs.update-type == 'version-update:semver-patch'
        run: |
          # Wait for CI to complete
          sleep 30
          
          # Auto-approve the PR
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.number }}/reviews" \
            -d '{"event": "APPROVE", "body": "Auto-approving dependabot minor/patch update"}'
          
          # Enable auto-merge
          curl -X PUT \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.number }}/merge" \
            -d '{"merge_method": "squash"}'

  # PR readiness check
  pr-readiness:
    name: PR Readiness Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Check PR readiness
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            
            const checks = [];
            
            // Check if PR has description
            if (!pr.body || pr.body.length < 20) {
              checks.push('‚ùå PR needs a detailed description');
            } else {
              checks.push('‚úÖ PR has description');
            }
            
            // Check if PR is not a draft
            if (pr.draft) {
              checks.push('‚ö†Ô∏è PR is marked as draft');
            } else {
              checks.push('‚úÖ PR is ready for review');
            }
            
            // Check if PR has labels
            if (pr.labels.length === 0) {
              checks.push('‚ö†Ô∏è PR has no labels (will be auto-labeled)');
            } else {
              checks.push('‚úÖ PR has labels');
            }
            
            // Check title format
            const titlePattern = /^(feat|fix|docs|style|refactor|test|chore)(\(.+\))?: .+/;
            if (!titlePattern.test(pr.title)) {
              checks.push('‚ö†Ô∏è PR title should follow conventional commit format');
            } else {
              checks.push('‚úÖ PR title follows conventional format');
            }
            
            // Create status comment
            const statusComment = `## üìã PR Readiness Checklist
            
${checks.join('\n')}

**Branch:** \`${pr.head.ref}\` ‚Üí \`${pr.base.ref}\`
**Commits:** ${pr.commits}
**Changed Files:** ${pr.changed_files}
**Additions:** +${pr.additions} **Deletions:** -${pr.deletions}

---
*This check runs automatically on every PR. Address any issues above for faster review.*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: statusComment
            });

  # Summary job
  dev-workflow-summary:
    name: Dev Workflow Summary
    runs-on: ubuntu-latest
    needs: [pr-labeling, conflict-check, code-quality, bundle-analysis, reviewer-assignment, pr-readiness]
    if: always() && github.event_name == 'pull_request'
    
    steps:
      - name: Create workflow summary
        run: |
          echo "## üîÑ Development Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Status" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| PR Labeling | ${{ needs.pr-labeling.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Conflict Check | ${{ needs.conflict-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Bundle Analysis | ${{ needs.bundle-analysis.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Reviewer Assignment | ${{ needs.reviewer-assignment.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PR Readiness | ${{ needs.pr-readiness.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. üîç Review code quality and bundle analysis reports" >> $GITHUB_STEP_SUMMARY
          echo "2. ‚úÖ Address any merge conflicts or formatting issues" >> $GITHUB_STEP_SUMMARY
          echo "3. üë• Wait for reviewer assignment and feedback" >> $GITHUB_STEP_SUMMARY
          echo "4. üöÄ PR will be ready to merge after approvals" >> $GITHUB_STEP_SUMMARY