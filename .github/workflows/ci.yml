name: Main CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  NODE_VERSION: '22'
  PYTHON_VERSION: '3.11'
  REGISTRY: ghcr.io
  USER: ${{ github.actor }}
  IMAGE_NAME: ${{ github.repository }}
  CI: true

jobs:
  # Detect changes to optimize CI runs
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.changes.outputs.backend }}
      frontend: ${{ steps.changes.outputs.frontend }}
      docker: ${{ steps.changes.outputs.docker }}
      workflows: ${{ steps.changes.outputs.workflows }}
      dependencies: ${{ steps.changes.outputs.dependencies }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            backend:
              - 'backend/**'
              - '!backend/README.md'
              - '!backend/**/*.md'
            frontend:
              - 'frontend/**'
              - '!frontend/README.md'
              - '!frontend/**/*.md'
            docker:
              - 'docker-compose*.yml'
              - '**/Dockerfile*'
              - '.dockerignore'
            workflows:
              - '.github/workflows/**'
            dependencies:
              - 'backend/requirements*.txt'
              - 'frontend/package*.json'

  # Quick validation jobs - run in parallel
  quick-checks:
    name: Quick Checks
    permissions:
      contents: read
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.backend == 'true' || needs.changes.outputs.frontend == 'true' }}

    strategy:
      fail-fast: false
      matrix:
        check: [backend-lint, frontend-lint, dependency-check]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python (if needed)
        if: matrix.check == 'backend-lint' || matrix.check == 'security-scan'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Setup Node.js (if needed)
        if: matrix.check == 'frontend-lint' || matrix.check == 'dependency-check'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Backend Lint & Format Check
        if: matrix.check == 'backend-lint' && needs.changes.outputs.backend == 'true'
        working-directory: ./backend
        run: |
          pip install -r requirements.txt
          pip install black==23.11.0 flake8 mypy pylint

          echo "::group::Black Format Check"
          black --check --diff --line-length=120 . || {
            echo "::error::Code formatting issues found. Run 'black --line-length=120 .' to fix."
            exit 1
          }
          echo "::endgroup::"

          echo "::group::Flake8 Linting"
          flake8 app \
            --max-line-length=120 \
            --extend-ignore=E203,W503,E501 \
            --count \
            --statistics \
            --show-source || {
            echo "::warning::Flake8 found linting issues. Review output above."
          }
          echo "::endgroup::"

          echo "::group::MyPy Type Checking"
          mypy app \
            --ignore-missing-imports \
            --no-strict-optional \
            --warn-unused-ignores \
            --warn-redundant-casts \
            --warn-unreachable \
            --pretty \
            --show-error-codes || {
            echo "::warning::Type checking found issues. Review mypy output above."
          }
          echo "::endgroup::"

          echo "::group::Pylint Code Quality"
          pylint app \
            --disable=C0111,R0903,C0103,R0913,R0914,W0212 \
            --max-line-length=120 \
            --output-format=colorized || {
            echo "::warning::Pylint found code quality issues. Review output above."
          }
          echo "::endgroup::"

      - name: Frontend Lint & Format Check
        if: matrix.check == 'frontend-lint' && needs.changes.outputs.frontend == 'true'
        working-directory: ./frontend
        run: |
          npm ci
          npm run lint || echo "Linting issues found"

      - name: Dependency Vulnerability Check
        if: matrix.check == 'dependency-check'
        run: |
          if [[ "${{ needs.changes.outputs.dependencies }}" == "true" ]]; then
            echo "Checking dependency vulnerabilities..."
            if [[ -f "backend/requirements.txt" ]]; then
              pip install safety || true
              safety check -r backend/requirements.txt --json || true
            fi
            if [[ -f "frontend/package.json" ]]; then
              cd frontend && npm audit --audit-level=moderate || true
            fi
          fi

  # Backend tests with PostgreSQL - split into multiple test suites
  backend-tests:
    name: Backend Tests (${{ matrix.test-suite }})
    runs-on: ubuntu-latest
    needs: [changes, quick-checks]
    if: ${{ always() && !failure() && needs.changes.outputs.backend == 'true' }}

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    strategy:
      fail-fast: false
      matrix:
        test-suite:
          - unit
          - integration
          - critical-workflows
        include:
          - test-suite: unit
            test-path: app/tests/test_*.py
            test-mark: "not integration and not asyncio"
            continue-on-error: true
          - test-suite: integration
            test-path: app/tests/test_*_service*.py
            test-mark: "integration or asyncio"
            continue-on-error: true
          - test-suite: critical-workflows
            test-path: app/tests/test_critical_workflows.py
            test-mark: "integration"
            continue-on-error: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt || pip install pytest pytest-asyncio pytest-cov

      - name: Wait for PostgreSQL
        run: |
          until pg_isready -h localhost -p 5432 -U test_user; do
            echo "Waiting for PostgreSQL to be ready..."
            sleep 2
          done

      - name: Initialize database schema with Alembic
        working-directory: ./backend
        env:
          DATABASE_URL: "postgresql+asyncpg://test_user:test_password@localhost:5432/test_db"
          DATABASE_URL_SYNC: "postgresql://test_user:test_password@localhost:5432/test_db"
          APP_ENV: test
          SECRET_KEY: test-secret-key-ci-backend-tests
          MINIO_ACCESS_KEY: ci-test-minio-access
          MINIO_SECRET_KEY: ci-test-minio-secret
        run: |
          echo "Running Alembic migrations..."
          alembic upgrade head

      - name: Seed test data
        working-directory: ./backend
        env:
          DATABASE_URL: "postgresql+asyncpg://test_user:test_password@localhost:5432/test_db"
          DATABASE_URL_SYNC: "postgresql://test_user:test_password@localhost:5432/test_db"
          APP_ENV: test
          TESTING: true
        run: |
          echo "Seeding test data..."
          python -m app.seed || echo "Seed script completed"

      - name: Run ${{ matrix.test-suite }} tests
        working-directory: ./backend
        env:
          DATABASE_URL: "postgresql+asyncpg://test_user:test_password@localhost:5432/test_db"
          DATABASE_URL_SYNC: "postgresql://test_user:test_password@localhost:5432/test_db"
          SECRET_KEY: test-secret-key-${{ matrix.test-suite }}
          APP_ENV: test
          TESTING: true
          PYTEST_CURRENT_TEST: true
        run: |
          python -m pytest ${{ matrix.test-path }} \
            -v \
            -m "${{ matrix.test-mark }}" \
            --cov=app \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --tb=short \
            --durations=10 \
            --maxfail=5
        continue-on-error: ${{ matrix.continue-on-error }}

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: backend/coverage.xml
          flags: backend-${{ matrix.test-suite }}
          name: backend-${{ matrix.test-suite }}-coverage
          fail_ci_if_error: false

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-backend-${{ matrix.test-suite }}
          path: |
            backend/coverage.xml
            backend/htmlcov/
            backend/.pytest_cache/
          retention-days: 7

  # Frontend tests
  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    needs: [changes, quick-checks]
    if: ${{ always() && !failure() && needs.changes.outputs.frontend == 'true' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run frontend tests
        working-directory: ./frontend
        run: npm run test:ci

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: frontend/coverage/lcov.info
          flags: frontend
          name: frontend-coverage
          fail_ci_if_error: false

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-frontend
          path: |
            frontend/coverage/
          retention-days: 7

  # Build and Deploy
  build-deploy:
    name: Build and Deploy
    permissions:
      packages: write
    runs-on: ubuntu-latest
    needs: [quick-checks, backend-tests, frontend-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GH_PAT }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.USER }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha

    - name: Copy email templates for backend build
      run: cp -r frontend/emails backend/emails

    - name: Build and push backend image
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.USER }}/scholarship-system-backend:latest
          ${{ env.REGISTRY }}/${{ env.USER }}/scholarship-system-backend:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          BUILD_DATE=${{ github.event.head_commit.timestamp }}
          VCS_REF=${{ github.sha }}

    - name: Build and push frontend image
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.USER }}/scholarship-system-frontend:latest
          ${{ env.REGISTRY }}/${{ env.USER }}/scholarship-system-frontend:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          NEXT_PUBLIC_API_URL=${{ secrets.PRODUCTION_API_URL || 'https://ss.aa.nycu.edu.tw' }}

    # - name: Deploy to staging
    #   if: github.ref == 'refs/heads/main'
    #   env:
    #     DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
    #   run: |
    #     echo "Deploying to staging environment..."
    #     # Add deployment commands here
    #     # Example: kubectl set image deployment/backend backend=${{ env.REGISTRY }}/${{ env.USER }}/scholarship-system-backend:${{ github.sha }}
    #     # Example: kubectl set image deployment/frontend frontend=${{ env.REGISTRY }}/${{ env.USER }}/scholarship-system-frontend:${{ github.sha }}

    # - name: Run smoke tests on staging
    #   run: |
    #     echo "Running smoke tests on staging..."
    #     # Add smoke test commands here
    #     # Example: curl -f https://staging.scholarship.example.com/api/v1/health || exit 1

  # Performance Tests
  performance-test:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Setup k6
      uses: grafana/setup-k6-action@v1

    - name: Run k6 smoke
      uses: grafana/run-k6-action@v1
      with:
        path: |
          perf/smoke.js
      env:
        BASE_URL: ${{ vars.K6_BASE_URL_STAGING }}
      continue-on-error: true

  # Notification
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [quick-checks, backend-tests, frontend-tests]
    if: always()

    steps:
    - name: Check job statuses
      id: job_status
      run: |
        if [[ "${{ needs.quick-checks.result }}" == "success" && \
              "${{ needs.backend-tests.result }}" == "success" && \
              "${{ needs.frontend-tests.result }}" == "success" ]]; then
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "status=failure" >> $GITHUB_OUTPUT
        fi

    - name: Create status summary
      run: |
        echo "## CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Quick Checks | ${{ needs.quick-checks.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Backend Tests | ${{ needs.backend-tests.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Frontend Tests | ${{ needs.frontend-tests.result }} |" >> $GITHUB_STEP_SUMMARY

    - name: Notify on success
      if: steps.job_status.outputs.status == 'success'
      run: |
        echo "✅ All tests passed successfully!"
        # Add notification logic (Slack, Discord, etc.)

    - name: Notify on failure
      if: steps.job_status.outputs.status == 'failure'
      run: |
        echo "❌ Some tests failed!"
        # Add notification logic (Slack, Discord, etc.)
