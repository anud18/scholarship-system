name: Deployment Pipeline

on:
  push:
    branches: [main]
    tags: ['v*.*.*']
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip pre-deployment tests'
        required: false
        type: boolean
        default: false

env:
  NODE_VERSION: '22'
  PYTHON_VERSION: '3.11'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Determine deployment targets
  pre-deployment:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    outputs:
      deploy-staging: ${{ steps.determine.outputs.deploy-staging }}
      version: ${{ steps.version.outputs.version }}
      skip-tests: ${{ steps.determine.outputs.skip-tests }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine deployment target
        id: determine
        run: |
          # Determine if staging deployment should run
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "deploy-staging=true" >> $GITHUB_OUTPUT
            echo "skip-tests=${{ github.event.inputs.skip_tests }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "deploy-staging=true" >> $GITHUB_OUTPUT
            echo "skip-tests=false" >> $GITHUB_OUTPUT
          else
            echo "deploy-staging=false" >> $GITHUB_OUTPUT
            echo "skip-tests=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate version
        id: version
        run: |
          if [[ "${{ github.ref }}" =~ ^refs/tags/ ]]; then
            version=${GITHUB_REF#refs/tags/}
          else
            version="main-$(git rev-parse --short HEAD)"
          fi
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "Generated version: $version"

      - name: Display deployment plan
        run: |
          echo "## üöÄ Deployment Plan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch/Tag**: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Targets" >> $GITHUB_STEP_SUMMARY
          echo "- **Staging**: ${{ steps.determine.outputs.deploy-staging }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Skip Tests**: ${{ steps.determine.outputs.skip-tests }}" >> $GITHUB_STEP_SUMMARY

  # Build and push Docker images
  build-images:
    name: Build & Push Images
    permissions:
      contents: read
      packages: write
    runs-on: ubuntu-latest
    needs: pre-deployment
    if: needs.pre-deployment.outputs.deploy-staging == 'true'

    strategy:
      matrix:
        component: [backend, frontend]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GH_PAT }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.actor }}/scholarship-system-${{ matrix.component }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=sha,prefix={{branch}}-
            type=raw,value=${{ needs.pre-deployment.outputs.version }}
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Copy email templates for backend build
        if: matrix.component == 'backend'
        run: cp -r frontend/emails backend/emails

      - name: Build and push ${{ matrix.component }} image
        id: docker_build
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.component }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}

      - name: Image digest
        run: |
          echo "Image digest for ${{ matrix.component }}: ${{ steps.docker_build.outputs.digest }}"

  # Deploy to staging environment
  deploy-staging:
    name: Deploy to Staging
    runs-on: [self-hosted, scholarship, test]
    needs: [pre-deployment, build-images]
    if: needs.pre-deployment.outputs.deploy-staging == 'true'
    environment:
      name: staging
      url: https://ss.test.nycu.edu.tw

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GH_PAT }}

      - name: Pull latest images
        run: |
          echo "Pulling Docker images..."
          docker pull ${{ env.REGISTRY }}/${{ github.actor }}/scholarship-system-backend:${{ needs.pre-deployment.outputs.version }}
          docker pull ${{ env.REGISTRY }}/${{ github.actor }}/scholarship-system-frontend:${{ needs.pre-deployment.outputs.version }}

      - name: Create deployment directory
        run: |
          mkdir -p ~/scholarship-staging
          mkdir -p ~/scholarship-staging/logs/nginx
          cd ~/scholarship-staging

      - name: Prepare deployment files
        run: |
          cp docker-compose.staging.yml ~/scholarship-staging/docker-compose.yml
          if [ -d nginx ]; then
            cp -r nginx ~/scholarship-staging/
            echo "Nginx config copied"
          fi
          if [ -d monitoring ]; then
            # Remove old monitoring directory if it exists (may have wrong permissions)
            sudo rm -rf ~/scholarship-staging/monitoring
            cp -r monitoring ~/scholarship-staging/
            echo "Monitoring config copied"
          fi
          cd ~/scholarship-staging
          echo "Deployment files prepared"

      - name: Stop old containers
        run: |
          cd ~/scholarship-staging
          docker compose down || true

      - name: Start new containers
        env:
          TAG: ${{ needs.pre-deployment.outputs.version }}
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
          DATABASE_URL_SYNC: ${{ secrets.STAGING_DATABASE_URL_SYNC }}
          SECRET_KEY: ${{ secrets.STAGING_SECRET_KEY }}
          CORS_ORIGINS: ${{ secrets.STAGING_CORS_ORIGINS }}
          MINIO_ENDPOINT: ${{ secrets.STAGING_MINIO_ENDPOINT }}
          MINIO_ACCESS_KEY: ${{ secrets.STAGING_MINIO_ACCESS_KEY }}
          MINIO_SECRET_KEY: ${{ secrets.STAGING_MINIO_SECRET_KEY }}
          MINIO_BUCKET: ${{ secrets.STAGING_MINIO_BUCKET }}
          FRONTEND_URL: ${{ secrets.STAGING_API_URL }}
          NEXT_PUBLIC_API_URL: ${{ secrets.STAGING_API_URL }}
          NEXT_PUBLIC_NYCU_PORTAL_URL: ${{ secrets.NEXT_PUBLIC_NYCU_PORTAL_URL }}
          NODE_ENV: ${{ secrets.NODE_ENV }}
          STUDENT_API_BASE_URL: ${{ secrets.STUDENT_API_BASE_URL }}
          STUDENT_API_ACCOUNT: ${{ secrets.STUDENT_API_ACCOUNT }}
          STUDENT_API_HMAC_KEY: ${{ secrets.STUDENT_API_HMAC_KEY }}
          SUPER_ADMIN_NYCU_ID: ${{ secrets.SUPER_ADMIN_NYCU_ID }}
        run: |
          cd ~/scholarship-staging
          docker compose up -d

          # Wait for backend to be ready
          echo "Waiting for backend to start..."
          sleep 15

      - name: Run database migrations
        run: |
          echo "Running Alembic migrations..."
          docker exec scholarship_backend_staging alembic upgrade head

      - name: Seed database (if needed)
        run: |
          echo "Seeding staging data..."
          docker exec scholarship_backend_staging python -m app.seed || echo "Seed completed with warnings"

      - name: Health check
        run: |
          echo "Running health checks..."

          # Backend health check
          max_retries=10
          retry_count=0
          until curl -f http://localhost:8000/health || [ $retry_count -eq $max_retries ]; do
            echo "Backend not ready yet... ($retry_count/$max_retries)"
            sleep 5
            retry_count=$((retry_count + 1))
          done

          if [ $retry_count -eq $max_retries ]; then
            echo "‚ùå Backend health check failed"
            docker compose -f ~/scholarship-staging/docker-compose.yml logs backend
            exit 1
          fi

          echo "‚úÖ Backend health check passed"

          # Frontend health check
          retry_count=0
          until curl -f http://localhost:3000 || [ $retry_count -eq $max_retries ]; do
            echo "Frontend not ready yet... ($retry_count/$max_retries)"
            sleep 5
            retry_count=$((retry_count + 1))
          done

          if [ $retry_count -eq $max_retries ]; then
            echo "‚ùå Frontend health check failed"
            docker compose -f ~/scholarship-staging/docker-compose.yml logs frontend
            exit 1
          fi

          echo "‚úÖ Frontend health check passed"

      - name: Run smoke tests
        run: |
          echo "Running smoke tests..."

          # Test API endpoints
          curl -f http://localhost:8000/health || exit 1
          curl -f http://localhost:8000/api/v1/docs || exit 1

          echo "‚úÖ Smoke tests passed"

      - name: Cleanup old images
        run: |
          echo "Cleaning up old Docker images (keeping latest 3 versions)..."

          # Cleanup old backend images (sorted by creation time, newest first)
          docker images ghcr.io/${{ github.actor }}/scholarship-system-backend \
            --format "{{.CreatedAt}}\t{{.Repository}}:{{.Tag}}" | \
            sort -r | \
            grep -v latest | \
            tail -n +4 | \
            awk -F '\\t' '$2 != "" && $2 !~ /<none>/{print $2}' | \
            xargs -r docker rmi -f || true

          # Cleanup old frontend images (sorted by creation time, newest first)
          docker images ghcr.io/${{ github.actor }}/scholarship-system-frontend \
            --format "{{.CreatedAt}}\t{{.Repository}}:{{.Tag}}" | \
            sort -r | \
            grep -v latest | \
            tail -n +4 | \
            awk -F '\\t' '$2 != "" && $2 !~ /<none>/{print $2}' | \
            xargs -r docker rmi -f || true

          # Cleanup dangling images
          docker image prune -f || true

          echo "‚úÖ Image cleanup completed"

      - name: Deployment summary
        run: |
          echo "## ‚úÖ Staging Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ needs.pre-deployment.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: Staging" >> $GITHUB_STEP_SUMMARY
          echo "**URL**: https://ss.test.nycu.edu.tw" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Services Status" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: ‚úÖ Running" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: ‚úÖ Running" >> $GITHUB_STEP_SUMMARY
          echo "- Database: ‚úÖ Migrated" >> $GITHUB_STEP_SUMMARY

  # Staging validation tests
  staging-tests:
    name: Staging Validation
    runs-on: [self-hosted, scholarship, test]
    needs: [pre-deployment, deploy-staging]
    if: needs.pre-deployment.outputs.deploy-staging == 'true' && needs.pre-deployment.outputs.skip-tests == 'false'

    steps:
      - name: Run integration tests
        run: |
          echo "Running integration tests against staging..."

          # Test authentication
          curl -f http://localhost:8000/health || exit 1

          # Test main endpoints
          curl -f http://localhost:8000/api/v1/scholarships || exit 1

          echo "‚úÖ Integration tests passed"

      - name: Performance check
        run: |
          echo "Checking staging performance..."

          # Basic response time check
          response_time=$(curl -o /dev/null -s -w '%{time_total}' http://localhost:8000/health)
          echo "Response time: ${response_time}s"

          # Fail if response time > 5 seconds
          if (( $(echo "$response_time > 5" | bc -l) )); then
            echo "‚ùå Performance check failed: Response time too high"
            exit 1
          fi

          echo "‚úÖ Performance check passed"

  # Notification
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [pre-deployment, deploy-staging, staging-tests]
    if: always()

    steps:
      - name: Deployment status
        run: |
          echo "## üìä Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ needs.pre-deployment.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-deployment | ${{ needs.pre-deployment.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy Staging | ${{ needs.deploy-staging.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Staging Tests | ${{ needs.staging-tests.result }} |" >> $GITHUB_STEP_SUMMARY
