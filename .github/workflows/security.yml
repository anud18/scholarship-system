name: Security

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '34 23 * * 4'  # Weekly on Thursday
  workflow_dispatch:
  workflow_call:  # Allow other workflows to invoke security scans

permissions:
  contents: read
  security-events: write
  pull-requests: write

env:
  NODE_VERSION: '22'
  PYTHON_VERSION: '3.13'

jobs:
  # CodeQL Analysis
  codeql:
    name: CodeQL Analysis (${{ matrix.language }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
        - language: actions
          build-mode: none
        - language: javascript-typescript
          build-mode: none
        - language: python
          build-mode: none

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: ${{ matrix.language }}
        build-mode: ${{ matrix.build-mode }}

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "codeql/language:${{matrix.language}}"

  # Backend Security Scan
  backend-security:
    name: Backend Security
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run security audit with pip-audit
        run: |
          pip install pip-audit
          pip-audit --desc --format json
        continue-on-error: true

      - name: Run Bandit security scan
        run: |
          pip install bandit
          bandit -r app/ -c .bandit -f json -o bandit-report.json
        continue-on-error: false

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-security-reports
          path: |
            backend/bandit-report.json
          retention-days: 30

  # Frontend Security Scan
  frontend-security:
    name: Frontend Security
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run security audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Run dependency scan with Snyk
        uses: snyk/actions/node@master
        if: github.event_name == 'pull_request'
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=medium
          command: test
        continue-on-error: true

  # Credential Management Security Validation
  credential-security:
    name: Credential Management Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect secrets with detect-secrets
        run: |
          pip install detect-secrets
          detect-secrets scan --baseline .secrets.baseline
        continue-on-error: false

      - name: Check for hardcoded credentials in code
        run: |
          echo "üîç Scanning for hardcoded credentials..."
          if grep -rn --include="*.{py,yml,yaml,js,ts,tsx}" \
            -E "(password|secret|api_key|token|hmac)\s*[:=]\s*[\"'][^\"'\$\{]+[\"']" \
            --exclude-dir=node_modules \
            --exclude-dir=.git \
            --exclude="*.example" \
            --exclude="*test*.py" \
            --exclude="*mock*.py" . | \
            grep -v "CHANGEME" | \
            grep -v "your-" | \
            grep -v "TODO" | \
            grep -v "# " | \
            grep -v 'password = ""'; then
            echo "‚ùå Found hardcoded credentials! Use environment variables instead."
            exit 1
          else
            echo "‚úÖ No hardcoded credentials found"
          fi

      - name: Validate docker-compose uses environment variables
        run: |
          echo "üîç Validating docker-compose credential management..."
          if grep -n --include="docker-compose*.yml" \
            -E "(POSTGRES_PASSWORD|MINIO_SECRET_KEY|SECRET_KEY|MINIO_ROOT_PASSWORD)\s*:\s*[a-zA-Z0-9_-]{8,}" . | \
            grep -v "\${" | \
            grep -v "env_file"; then
            echo "‚ùå Found hardcoded credentials in docker-compose! Use environment variables with \${VAR} syntax."
            exit 1
          else
            echo "‚úÖ Docker-compose files properly use environment variables"
          fi

      - name: Verify .env files are in .gitignore
        run: |
          echo "üîç Checking .gitignore configuration..."
          if ! grep -q "^\.env$" .gitignore || \
             ! grep -q "^\.env\.dev$" .gitignore || \
             ! grep -q "^\.env\.staging$" .gitignore || \
             ! grep -q "^\.env\.prod$" .gitignore; then
            echo "‚ùå .env files not properly excluded in .gitignore"
            exit 1
          else
            echo "‚úÖ .env files properly excluded from git"
          fi

      - name: Check Grafana config is not in git
        run: |
          echo "üîç Checking Grafana configuration..."
          if git ls-files | grep -q "monitoring/config/grafana/grafana.ini$"; then
            echo "‚ùå grafana.ini should not be tracked! Only grafana.ini.example should be in git."
            exit 1
          else
            echo "‚úÖ Grafana configuration properly handled"
          fi

      - name: Validate backend config has no default credentials
        run: |
          echo "üîç Validating backend configuration..."
          if grep -n "minio_access_key.*=.*\".*\"" backend/app/core/config.py | grep -v "Required:"; then
            echo "‚ùå Found default MinIO credentials in config.py"
            exit 1
          else
            echo "‚úÖ Backend configuration requires environment variables"
          fi

      - name: Security validation summary
        if: success()
        run: |
          echo "üéâ All credential security validations passed!"
          echo "‚úÖ No hardcoded credentials"
          echo "‚úÖ Docker-compose uses environment variables"
          echo "‚úÖ .env files excluded from git"
          echo "‚úÖ Grafana config not committed"
          echo "‚úÖ Backend config requires environment variables"

  # Dependency Updates Check
  dependency-check:
    name: Dependency Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for outdated Python dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pip-audit
          pip-audit --desc -r requirements.txt
        continue-on-error: true

      - name: Check for outdated Node.js dependencies
        working-directory: ./frontend
        run: |
          npm outdated || true
        continue-on-error: true

      - name: Create security summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `## üîí Security Scan Summary

            - ‚úÖ CodeQL Analysis completed
            - ‚úÖ Backend security scan completed
            - ‚úÖ Frontend security scan completed
            - ‚úÖ Credential management validation completed
            - ‚úÖ Dependency check completed

            Check the workflow artifacts for detailed reports.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary
            });
