name: Security

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '34 23 * * 4'  # Weekly on Thursday
  workflow_dispatch:
  workflow_call:  # Allow other workflows to invoke security scans

permissions:
  contents: read
  security-events: write
  pull-requests: write

env:
  NODE_VERSION: '22'
  PYTHON_VERSION: '3.10'

jobs:
  # CodeQL Analysis
  codeql:
    name: CodeQL Analysis (${{ matrix.language }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
        - language: actions
          build-mode: none
        - language: javascript-typescript
          build-mode: none
        - language: python
          build-mode: none

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: ${{ matrix.language }}
        build-mode: ${{ matrix.build-mode }}

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "codeql/language:${{matrix.language}}"

  # Backend Security Scan
  backend-security:
    name: Backend Security
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run security audit with Safety
        run: |
          pip install safety
          safety scan --json
        continue-on-error: true

      - name: Run Bandit security scan
        run: |
          pip install bandit
          bandit -r app/ -c .bandit -f json -o bandit-report.json
        continue-on-error: false

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-security-reports
          path: |
            backend/bandit-report.json
          retention-days: 30

  # Frontend Security Scan
  frontend-security:
    name: Frontend Security
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run security audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Run dependency scan with Snyk
        uses: snyk/actions/node@master
        if: github.event_name == 'pull_request'
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=medium
          command: test
        continue-on-error: true

  # Dependency Updates Check
  dependency-check:
    name: Dependency Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for outdated Python dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pip-audit
          pip-audit --desc -r requirements.txt
        continue-on-error: true

      - name: Check for outdated Node.js dependencies
        working-directory: ./frontend
        run: |
          npm outdated || true
        continue-on-error: true

      - name: Create security summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `## ðŸ”’ Security Scan Summary

            - âœ… CodeQL Analysis completed
            - âœ… Backend security scan completed
            - âœ… Frontend security scan completed
            - âœ… Dependency check completed

            Check the workflow artifacts for detailed reports.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary
            });
