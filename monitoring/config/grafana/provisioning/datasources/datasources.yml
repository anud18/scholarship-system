# Grafana Datasource Provisioning Configuration
# Automatically provisions Prometheus and Loki datasources on startup

apiVersion: 1

datasources:
  # =========================================================================
  # PROMETHEUS - Metrics Database
  # =========================================================================
  - name: Prometheus
    type: prometheus
    uid: prometheus-uid
    orgId: 1
    access: proxy
    url: http://prometheus:9090
    isDefault: true
    editable: false
    jsonData:
      httpMethod: POST
      timeInterval: 15s
      queryTimeout: 60s
      # Cache settings for better performance
      cacheLevel: High
      incrementalQuerying: true
      incrementalQueryOverlapWindow: 10m
      # Enable exemplars for tracing (if used in future)
      exemplarTraceIdDestinations:
        - name: trace_id
          datasourceUid: tempo  # For future Tempo integration
    version: 1

  # =========================================================================
  # LOKI - STAGING TENANT
  # =========================================================================
  - name: Loki (Staging)
    type: loki
    uid: loki-staging-uid
    orgId: 1
    access: proxy
    url: http://loki:3100
    editable: false
    jsonData:
      maxLines: 1000
      timeout: 60
      # Multi-tenant configuration for staging
      httpHeaderName1: 'X-Scope-OrgID'
      # Derived fields for linking logs to traces (future use)
      derivedFields:
        - name: TraceID
          matcherRegex: "trace_id=(\\w+)"
          url: "$${__value.raw}"
          datasourceUid: tempo
    secureJsonData:
      httpHeaderValue1: 'staging'
    version: 1

  # =========================================================================
  # LOKI - PRODUCTION TENANT
  # =========================================================================
  - name: Loki (Production)
    type: loki
    uid: loki-prod-uid
    orgId: 1
    access: proxy
    url: http://loki:3100
    editable: false
    jsonData:
      maxLines: 1000
      timeout: 60
      # Multi-tenant configuration for production
      httpHeaderName1: 'X-Scope-OrgID'
      # Derived fields for linking logs to traces (future use)
      derivedFields:
        - name: TraceID
          matcherRegex: "trace_id=(\\w+)"
          url: "$${__value.raw}"
          datasourceUid: tempo
    secureJsonData:
      httpHeaderValue1: 'prod'
    version: 1

  # =========================================================================
  # LOKI - DEV TENANT (Optional, for future use)
  # =========================================================================
  - name: Loki (Dev)
    type: loki
    uid: loki-dev-uid
    orgId: 1
    access: proxy
    url: http://loki:3100
    editable: false
    jsonData:
      maxLines: 1000
      timeout: 60
      # Multi-tenant configuration for dev
      httpHeaderName1: 'X-Scope-OrgID'
      # Derived fields for linking logs to traces (future use)
      derivedFields:
        - name: TraceID
          matcherRegex: "trace_id=(\\w+)"
          url: "$${__value.raw}"
          datasourceUid: tempo
    secureJsonData:
      httpHeaderValue1: 'dev'
    version: 1

  # =========================================================================
  # ALERTMANAGER
  # =========================================================================
  - name: AlertManager
    type: alertmanager
    uid: alertmanager-uid
    orgId: 1
    access: proxy
    url: http://alertmanager:9093
    editable: false
    jsonData:
      implementation: prometheus
      handleGrafanaManagedAlerts: true
    version: 1
